

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.scheduler &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>arc.scheduler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.scheduler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># encoding: utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for scheduling jobs</span>
<span class="sd">Includes spawning, terminating, checking, and troubleshooting various jobs</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="kn">from</span> <span class="nn">rmgpy.reaction</span> <span class="kn">import</span> <span class="n">Reaction</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="kn">import</span> <span class="n">format_level_of_theory_for_logging</span><span class="p">,</span> <span class="n">format_level_of_theory_inputs</span><span class="p">,</span> <span class="n">get_logger</span><span class="p">,</span> \
    <span class="n">get_ordinal_indicator</span><span class="p">,</span> <span class="n">extermum_list</span><span class="p">,</span> <span class="n">read_yaml_file</span><span class="p">,</span> <span class="n">save_yaml_file</span><span class="p">,</span> <span class="n">sort_two_lists_by_the_first</span>
<span class="kn">from</span> <span class="nn">arc</span> <span class="kn">import</span> <span class="n">plotter</span>
<span class="kn">from</span> <span class="nn">arc</span> <span class="kn">import</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">arc.job.job</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">arc.exceptions</span> <span class="kn">import</span> <span class="n">InputError</span><span class="p">,</span> <span class="n">SanitizationError</span><span class="p">,</span> <span class="n">SchedulerError</span><span class="p">,</span> <span class="n">SpeciesError</span><span class="p">,</span> <span class="n">TSError</span>
<span class="kn">from</span> <span class="nn">arc.job.local</span> <span class="kn">import</span> <span class="n">check_running_jobs_ids</span>
<span class="kn">from</span> <span class="nn">arc.job.ssh</span> <span class="kn">import</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">arc.job.trsh</span> <span class="kn">import</span> <span class="n">trsh_negative_freq</span><span class="p">,</span> <span class="n">trsh_scan_job</span><span class="p">,</span> <span class="n">trsh_ess_job</span><span class="p">,</span> <span class="n">trsh_conformer_isomorphism</span><span class="p">,</span> <span class="n">scan_quality_check</span>
<span class="kn">from</span> <span class="nn">arc.species.species</span> <span class="kn">import</span> <span class="n">ARCSpecies</span><span class="p">,</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">,</span> <span class="n">determine_rotor_symmetry</span><span class="p">,</span> <span class="n">TSGuess</span>
<span class="kn">from</span> <span class="nn">arc.species.converter</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_isomorphism</span><span class="p">,</span>
                                   <span class="n">compare_confs</span><span class="p">,</span>
                                   <span class="n">molecules_from_xyz</span><span class="p">,</span>
                                   <span class="n">standardize_xyz_string</span><span class="p">,</span>
                                   <span class="n">str_to_xyz</span><span class="p">,</span>
                                   <span class="n">xyz_to_coords_list</span><span class="p">,</span>
                                   <span class="n">xyz_to_str</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.ts.atst</span> <span class="kn">import</span> <span class="n">autotst</span>
<span class="kn">from</span> <span class="nn">arc.settings</span> <span class="kn">import</span> <span class="n">default_job_types</span><span class="p">,</span> <span class="n">rotor_scan_resolution</span>
<span class="kn">import</span> <span class="nn">arc.rmgdb</span> <span class="k">as</span> <span class="nn">rmgdb</span>
<span class="kn">import</span> <span class="nn">arc.species.conformers</span> <span class="k">as</span> <span class="nn">conformers</span>  <span class="c1"># import after importing plotter to avoid circular import</span>
<span class="kn">from</span> <span class="nn">arc.species.vectors</span> <span class="kn">import</span> <span class="n">get_angle</span><span class="p">,</span> <span class="n">calculate_dihedral_angle</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARC&#39;s Scheduler class. Creates jobs, submits, checks status, troubleshoots.</span>
<span class="sd">    Each species in `species_list` has to have a unique label.</span>

<span class="sd">    Dictionary structures::</span>

<span class="sd">        job_dict = {label_1: {&#39;conformers&#39;: {0: Job1,</span>
<span class="sd">                                             1: Job2, ...},  # TS guesses are considered `conformers` as well</span>
<span class="sd">                              &#39;opt&#39;:        {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;sp&#39;:         {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;freq&#39;:       {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;composite&#39;:  {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;scan&#39;:       {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &lt;job_type&gt;:   {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              ...</span>
<span class="sd">                              }</span>
<span class="sd">                    label_2: {...},</span>
<span class="sd">                    }</span>

<span class="sd">        output = {label_1: {&#39;job_types&#39;: {job_type1: &lt;status1&gt;,  # boolean</span>
<span class="sd">                                          job_type2: &lt;status2&gt;,</span>
<span class="sd">                                         },</span>
<span class="sd">                            &#39;paths&#39;: {&#39;geo&#39;: &lt;path to geometry optimization output file&gt;,</span>
<span class="sd">                                      &#39;freq&#39;: &lt;path to freq output file&gt;,</span>
<span class="sd">                                      &#39;sp&#39;: &lt;path to sp output file&gt;,</span>
<span class="sd">                                      &#39;composite&#39;: &lt;path to composite output file&gt;,</span>
<span class="sd">                                      &#39;irc&#39;: [list of two IRC paths],</span>
<span class="sd">                                     },</span>
<span class="sd">                            &#39;conformers&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;isomorphism&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;convergence&#39;: &lt;status&gt;,  # boolean</span>
<span class="sd">                            &#39;restart&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;info&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;warnings&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;errors&#39;: &lt;comments&gt;,</span>
<span class="sd">                           },</span>
<span class="sd">                 label_2: {...},</span>
<span class="sd">                 }</span>

<span class="sd">    Note: The rotor scan dicts are located under Species.rotors_dict</span>

<span class="sd">    Args:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the working directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_list (list): Contains input :ref:`ARCSpecies &lt;species&gt;` objects (both species and TSs).</span>
<span class="sd">        rxn_list (list): Contains input :ref:`ARCReaction &lt;reaction&gt;` objects.</span>
<span class="sd">        project_directory (str): Folder path for the project: the input file path or ARC/Projects/project-name.</span>
<span class="sd">        composite_method (str, optional): A composite method to use.</span>
<span class="sd">        conformer_level (str or dict, optional): The level of theory to use for conformer comparisons.</span>
<span class="sd">        opt_level (str or dict, optional): The level of theory to use for geometry optimizations.</span>
<span class="sd">        freq_level (str or dict, optional): The level of theory to use for frequency calculations.</span>
<span class="sd">        sp_level (str or dict, optional): The level of theory to use for single point energy calculations.</span>
<span class="sd">        scan_level (str or dict, optional): The level of theory to use for torsion scans.</span>
<span class="sd">        ts_guess_level (str or dict, optional): The level of theory to use for TS guess comparisons.</span>
<span class="sd">        irc_level (str or dict, optional): The level of theory to use for IRC calculations.</span>
<span class="sd">        orbitals_level (str or dict, optional): The level of theory to use for calculating MOs (for plotting).</span>
<span class="sd">        adaptive_levels (dict, optional): A dictionary of levels of theory for ranges of the number of heavy atoms in</span>
<span class="sd">                                          the molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are</span>
<span class="sd">                                          dictionaries with &#39;optfreq&#39; and &#39;sp&#39; as keys and levels of theory as values.</span>
<span class="sd">        rmg_database (RMGDatabase, optional): The RMG database object.</span>
<span class="sd">        job_types (dict, optional): A dictionary of job types to execute. Keys are job types, values are boolean.</span>
<span class="sd">        job_additional_options (dict, optional): Additional specifications to control the execution of a job.</span>
<span class="sd">        job_shortcut_keywords (dict, optional): Shortcut keyword specifications to control the execution of a job.</span>
<span class="sd">        bath_gas (str, optional): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                                  Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        restart_dict (dict, optional): A restart dictionary parsed from a YAML restart file.</span>
<span class="sd">        max_job_time (float, optional): The maximal allowed job time on the server in hours (can be fractional).</span>
<span class="sd">        allow_nonisomorphic_2d (bool, optional): Whether to optimize species even if they do not have a 3D conformer</span>
<span class="sd">                                                 that is isomorphic to the 2D graph representation.</span>
<span class="sd">        memory (float, optional): The total allocated job memory in GB (14 by default).</span>
<span class="sd">        testing (bool, optional): Used for internal ARC testing (generating the object w/o executing it).</span>
<span class="sd">        dont_gen_confs (list, optional): A list of species labels for which conformer jobs were loaded from a restart</span>
<span class="sd">                                         file, or user-requested. Additional conformer generation should be avoided.</span>
<span class="sd">        n_confs (int, optional): The number of lowest force field conformers to consider.</span>
<span class="sd">        e_confs (float, optional): The energy threshold in kJ/mol above the lowest energy conformer below which</span>
<span class="sd">                                   force field conformers are considered.</span>
<span class="sd">        solvent (dict): This argument, if not None, requests that a calculation be performed in the presence of a</span>
<span class="sd">                        solvent by placing the solute in a cavity within the solvent reaction field.</span>
<span class="sd">                        Keys are:</span>
<span class="sd">                        - &#39;method&#39; (optional values: &#39;pcm&#39; (default), &#39;cpcm&#39;, &#39;dipole&#39;, &#39;ipcm&#39;, &#39;scipcm&#39;)</span>
<span class="sd">                        -  &#39;solvent&#39; (values are strings of &quot;known&quot; solvents, see https://gaussian.com/scrf/,</span>
<span class="sd">                                      default is &quot;water&quot;)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the working directory.</span>
<span class="sd">        servers (list): A list of servers used for the present project.</span>
<span class="sd">        species_list (list): Contains input :ref:`ARCSpecies &lt;species&gt;` objects (both species and TSs).</span>
<span class="sd">        species_dict (dict): Keys are labels, values are :ref:`ARCSpecies &lt;species&gt;` objects.</span>
<span class="sd">        rxn_list (list): Contains input :ref:`ARCReaction &lt;reaction&gt;` objects.</span>
<span class="sd">        unique_species_labels (list): A list of species labels (checked for duplicates).</span>
<span class="sd">        adaptive_levels (dict): A dictionary of levels of theory for ranges of the number of heavy atoms in the</span>
<span class="sd">                                molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are</span>
<span class="sd">                                dictionaries with &#39;optfreq&#39; and &#39;sp&#39; as keys and levels of theory as values.</span>
<span class="sd">        job_dict (dict): A dictionary of all scheduled jobs. Keys are species / TS labels,</span>
<span class="sd">                         values are dictionaries where keys are job names (corresponding to</span>
<span class="sd">                         &#39;running_jobs&#39; if job is running) and values are the Job objects.</span>
<span class="sd">        running_jobs (dict): A dictionary of currently running jobs (a subset of `job_dict`).</span>
<span class="sd">                             Keys are species/TS label, values are lists of job names (e.g. &#39;conformer3&#39;, &#39;opt_a123&#39;).</span>
<span class="sd">        servers_jobs_ids (list): A list of relevant job IDs currently running on the server.</span>
<span class="sd">        output (dict): Output dictionary with status per job type and final QM file paths for all species.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        job_additional_options (dict): Additional specifications to control the execution of a job.</span>
<span class="sd">        job_shortcut_keywords (dict): Shortcut keyword specifications to control the execution of a job.</span>
<span class="sd">        restart_dict (dict): A restart dictionary parsed from a YAML restart file.</span>
<span class="sd">        project_directory (str): Folder path for the project: the input file path or ARC/Projects/project-name.</span>
<span class="sd">        save_restart (bool): Whether to start saving a restart file. ``True`` only after all species are loaded</span>
<span class="sd">                             (otherwise saves a partial file and may cause loss of information).</span>
<span class="sd">        restart_path (str): Path to the `restart.yml` file to be saved.</span>
<span class="sd">        max_job_time (float): The maximal allowed job time on the server in hours (can be fractional).</span>
<span class="sd">        testing (bool): Used for internal ARC testing (generating the object w/o executing it).</span>
<span class="sd">        rmg_database (RMGDatabase): The RMG database object.</span>
<span class="sd">        allow_nonisomorphic_2d (bool): Whether to optimize species even if they do not have a 3D conformer that is</span>
<span class="sd">                                       isomorphic to the 2D graph representation.</span>
<span class="sd">        dont_gen_confs (list): A list of species labels for which conformer jobs were loaded from a restart file,</span>
<span class="sd">                               or user-requested. Additional conformer generation should be avoided for them.</span>
<span class="sd">        memory (float): The total allocated job memory in GB (14 by default).</span>
<span class="sd">        n_confs (int): The number of lowest force field conformers to consider.</span>
<span class="sd">        e_confs (float): The energy threshold in kJ/mol above the lowest energy conformer below which</span>
<span class="sd">                         force field conformers are considered.</span>
<span class="sd">        job_types (dict): A dictionary of job types to execute. Keys are job types, values are boolean.</span>
<span class="sd">        bath_gas (str): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                        Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        composite_method (str): A composite method to use.</span>
<span class="sd">        conformer_level (dict): The level of theory to use for conformer comparisons.</span>
<span class="sd">        opt_level (dict): The level of theory to use for geometry optimizations.</span>
<span class="sd">        freq_level (dict): The level of theory to use for frequency calculations.</span>
<span class="sd">        sp_level (dict): The level of theory to use for single point energy calculations.</span>
<span class="sd">        scan_level (dict): The level of theory to use for torsion scans.</span>
<span class="sd">        ts_guess_level (dict): The level of theory to use for TS guess comparisons.</span>
<span class="sd">        irc_level (dict): The level of theory to use for IRC calculations.</span>
<span class="sd">        orbitals_level (dict): The level of theory to use for calculating MOs (for plotting).</span>
<span class="sd">        adaptive_levels (dict): A dictionary of levels of theory for ranges of the number of heavy atoms in</span>
<span class="sd">                                  the molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are</span>
<span class="sd">                                  dictionaries with &#39;optfreq&#39; and &#39;sp&#39; as keys and levels of theory as values.</span>
<span class="sd">        solvent (dict): The solvent model and solvent to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">ess_settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">species_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                 <span class="n">project_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">composite_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">conformer_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">opt_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">freq_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">sp_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">scan_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">ts_guess_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">irc_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">orbitals_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">adaptive_levels</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">rmg_database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_types</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_additional_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">solvent</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_shortcut_keywords</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">rxn_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">bath_gas</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">restart_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_job_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
                 <span class="n">allow_nonisomorphic_2d</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">memory</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
                 <span class="n">testing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">dont_gen_confs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">n_confs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">e_confs</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmg_database</span> <span class="o">=</span> <span class="n">rmg_database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="o">=</span> <span class="n">restart_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="o">=</span> <span class="n">species_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span> <span class="o">=</span> <span class="n">rxn_list</span> <span class="k">if</span> <span class="n">rxn_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span> <span class="o">=</span> <span class="n">ess_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span> <span class="o">=</span> <span class="n">project_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="o">=</span> <span class="n">allow_nonisomorphic_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="n">bath_gas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solvent</span> <span class="o">=</span> <span class="n">solvent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="o">=</span> <span class="n">adaptive_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span> <span class="o">=</span> <span class="n">n_confs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span> <span class="o">=</span> <span class="n">e_confs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span> <span class="o">=</span> <span class="n">dont_gen_confs</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span> <span class="o">=</span> <span class="n">job_types</span> <span class="k">if</span> <span class="n">job_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_job_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;running_jobs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_running_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;restart.yml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># init time for reporting status every 1 hr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="o">=</span> <span class="n">composite_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span> <span class="o">=</span> <span class="n">conformer_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span> <span class="o">=</span> <span class="n">ts_guess_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="n">opt_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span> <span class="o">=</span> <span class="n">freq_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="o">=</span> <span class="n">sp_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span> <span class="o">=</span> <span class="n">scan_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irc_level</span> <span class="o">=</span> <span class="n">irc_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitals_level</span> <span class="o">=</span> <span class="n">orbitals_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_additional_options</span> <span class="o">=</span> <span class="n">job_additional_options</span> <span class="k">if</span> <span class="n">job_additional_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_shortcut_keywords</span> <span class="o">=</span> <span class="n">job_shortcut_keywords</span> <span class="k">if</span> <span class="n">job_shortcut_keywords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">):</span>
            <span class="n">rxn_info_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_reaction_labels_info_file</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loading RMG&#39;s families...&quot;</span><span class="p">)</span>
            <span class="n">rmgdb</span><span class="o">.</span><span class="n">load_families_only</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmg_database</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># update the ARCReaction object and generate an ARCSpecies object for its TS</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">p_species</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reactants</span><span class="p">:</span>
                        <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
                        <span class="n">rxn</span><span class="o">.</span><span class="n">p_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction_from_arc_species</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">check_attributes</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_family</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmg_database</span><span class="p">)</span>
                <span class="n">family_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">family_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;identified as belonging to RMG family </span><span class="si">{rxn.family.label}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family_own_reverse</span><span class="p">:</span>
                        <span class="n">family_text</span> <span class="o">+=</span> <span class="s2">&quot;, which is its own reverse&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Considering reaction: </span><span class="si">{rxn.label}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">family_text</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{family_text}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_rxn_charge</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_rxn_multiplicity</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;TS</span><span class="si">{rxn.index}</span><span class="s1">&#39;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{rxn.ts_label}</span><span class="s1">: </span><span class="si">{rxn.label}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">family_text</span><span class="p">:</span>
                        <span class="n">family_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">(</span><span class="si">{family_text}</span><span class="s1">)&#39;</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">family_text</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;user guess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">:</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;user guess&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="s1">&#39;user guess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">]):</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;{len(rxn.ts_xyz_guess)} user guesses&#39;</span><span class="p">)</span>
                <span class="n">auto_tst</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">reverse_auto_tst</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;autotst&#39;</span><span class="p">:</span>
                        <span class="n">auto_tst</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;reverse_autotst&#39;</span><span class="p">:</span>
                        <span class="n">reverse_auto_tst</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family_own_reverse</span> <span class="ow">and</span> <span class="n">auto_tst</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse_auto_tst</span><span class="p">:</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;reverse_autotst&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">]):</span>
                    <span class="n">ts_species</span> <span class="o">=</span> <span class="n">ARCSpecies</span><span class="p">(</span><span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">,</span> <span class="n">rxn_label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">multiplicity</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">compute_thermo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">ts_methods</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">,</span> <span class="n">ts_number</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">ts_species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">reactant</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="k">for</span> <span class="n">reactant</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_species</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The TS species was already loaded from a restart dict or an Arkane YAML file</span>
                    <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">:</span>
                            <span class="n">ts_species</span> <span class="o">=</span> <span class="n">spc</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">label</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span> <span class="o">=</span> <span class="n">ts_species</span>
                <span class="c1"># Generate TSGuess objects for all methods, start with the user guesses</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_guess</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">):</span>  <span class="c1"># this is a list of guesses, could be empty</span>
                    <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TSGuess</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;user guess </span><span class="si">{i}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">user_guess</span><span class="p">,</span>
                                                         <span class="n">rmg_reaction</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">tsm</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">:</span>
                    <span class="c1"># loop through all ts methods of this reaction, generate a TSGuess object if not a user guess</span>
                    <span class="k">if</span> <span class="s1">&#39;user guess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tsm</span><span class="p">:</span>
                        <span class="n">rmg_reaction</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span>
                        <span class="k">if</span> <span class="n">tsm</span> <span class="o">==</span> <span class="s1">&#39;reverse_autotst&#39;</span><span class="p">:</span>
                            <span class="n">rmg_reaction</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span><span class="n">reactants</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="o">.</span><span class="n">products</span><span class="p">,</span>
                                                    <span class="n">products</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="o">.</span><span class="n">reactants</span><span class="p">)</span>
                        <span class="n">family</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TSGuess</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">tsm</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">family</span><span class="p">,</span> <span class="n">rmg_reaction</span><span class="o">=</span><span class="n">rmg_reaction</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ts_guess</span> <span class="ow">in</span> <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                    <span class="c1"># Execute the TS guess methods that don&#39;t require optimized reactants and products</span>
                    <span class="k">if</span> <span class="s1">&#39;autotst&#39;</span> <span class="ow">in</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">method</span> <span class="ow">and</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">reverse</span> <span class="o">=</span> <span class="s1">&#39; in the reverse direction&#39;</span> <span class="k">if</span> <span class="s1">&#39;reverse&#39;</span> <span class="ow">in</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">method</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to generating a TS guess for </span><span class="si">{ts_guess.family}</span><span class="s1"> reaction </span><span class="si">{rxn.label}</span><span class="s1"> &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;using AutoTST</span><span class="si">{reverse}</span><span class="s1">...&#39;</span><span class="p">)</span>
                        <span class="n">ts_guess</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ts_guess</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">autotst</span><span class="p">(</span><span class="n">rmg_reaction</span><span class="o">=</span><span class="n">ts_guess</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="p">,</span> <span class="n">reaction_family</span><span class="o">=</span><span class="n">ts_guess</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">TSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not generate an AutoTST guess for reaction </span><span class="si">{rxn.label}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">ts_guess</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="n">ts_guess</span><span class="o">.</span><span class="n">execution_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># spawn other methods as needed when they are implemented (job_type = &#39;ts_guess&#39;);</span>
                        <span class="c1"># add to job_dict only spawn if `ts_guess.xyz is None` (restart)</span>
                        <span class="k">pass</span>

        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">ARCSpecies</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Each species in `species_list` must be an ARCSpecies object. &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;Got type {type(species)} for </span><span class="si">{species.label}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Each species in `species_list` has to have a unique label. &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;Label of species </span><span class="si">{species.label}</span><span class="s1"> is not unique.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_output_dict_contain_info</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;restart&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Restarted ARC at {datetime.datetime.now()}; &#39;</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_rotors</span> \
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># if species.rotors_dict is None, it means the species is marked to not spawn rotor scans</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">determine_rotors</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># opt wasn&#39;t asked for, and it&#39;s not needed, declare it as converged</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># initialize before running the first job</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> is monoatomic&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">:</span>
                        <span class="c1"># generate a simple &quot;Symbol   0.0   0.0   0.0&quot; coords in a dictionary format</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">symbol</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine element of monoatomic species </span><span class="si">{species.label}</span><span class="s1">. &#39;</span>
                                           <span class="sa">f</span><span class="s1">&#39;Assuming element is </span><span class="si">{symbol}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">monoatomic_xyz_dict</span> <span class="o">=</span> <span class="n">str_to_xyz</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">   0.0   0.0   0.0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">monoatomic_xyz_dict</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">monoatomic_xyz_dict</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                            <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="c1"># No need to run opt/freq jobs for a monoatomic species, only run sp (or composite if relevant)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                      <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                    <span class="c1"># For restarting purposes: check before running jobs whether they were already terminated</span>
                    <span class="c1"># (check self.output) or whether they are &quot;currently running&quot; (check self.job_dict)</span>
                    <span class="c1"># This section takes care of restarting a Species (including a TS), but does not</span>
                    <span class="c1"># deal with conformers nor with ts_guesses</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="c1"># composite-related restart</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> \
                                <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="c1"># doing composite; composite hasn&#39;t finished and is not running; spawn composite</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> \
                                <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>
                                     <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># non-composite-related restart</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">])</span> <span class="ow">or</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                 <span class="ow">and</span> <span class="s1">&#39;fine&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                            <span class="c1"># opt/fine isn&#39;t running</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]:</span>
                                <span class="c1"># opt/fine hasn&#39;t finished (and isn&#39;t running), so run it</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># opt/fine is done, check post-opt job types</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                                        <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>
                                             <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
                                    <span class="c1"># some restart-related checks are performed within run_scan_jobs()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Species is loaded from an Arkane YAML file (no need to execute any job)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Loaded from an Arkane YAML file; &#39;</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="c1"># This is a TS loaded from a YAML file</span>
                    <span class="n">species</span><span class="o">.</span><span class="n">ts_conf_spawned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_jobs</span><span class="p">()</span>

<div class="viewcode-block" id="Scheduler.schedule_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.schedule_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main job scheduling block</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">conformers</span> \
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">]):</span>
                <span class="c1"># the species has no xyz, but has conformers and at least one of the conformers has energy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_stable_conformer</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">!=</span> <span class="p">{}:</span>  <span class="c1"># loop while jobs are still running</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Currently running jobs:</span><span class="se">\n</span><span class="si">{self.running_jobs}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">job_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="c1"># look for completed jobs and decide what jobs to run next</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_servers_jobs_ids</span><span class="p">()</span>  <span class="c1"># updates `self.servers_jobs_ids`</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="p">[</span><span class="mi">9</span><span class="p">:])</span>  <span class="c1"># the conformer number. parsed from a string like &#39;conformer12&#39;.</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                            <span class="c1"># this is a completed conformer job</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">parse_conformer</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                            <span class="c1"># Just terminated a conformer job.</span>
                            <span class="c1"># Are there additional conformer jobs currently running for this species?</span>
                            <span class="k">for</span> <span class="n">spec_jobs</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">spec_jobs</span> <span class="ow">and</span> <span class="n">spec_jobs</span> <span class="o">!=</span> <span class="n">job_name</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># All conformer jobs terminated.</span>
                                <span class="c1"># Check isomorphism and run opt on most stable conformer geometry.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conformer jobs for </span><span class="si">{label}</span><span class="s1"> successfully terminated.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_stable_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># also checks isomorphism</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="c1"># if initial_xyz is None, then we&#39;re probably troubleshooting conformers, don&#39;t opt</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="c1"># val is &#39;opt1&#39;, &#39;opt2&#39;, etc., or &#39;optfreq1&#39;, optfreq2&#39;, etc.</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_post_opt_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="c1"># this is NOT an &#39;optfreq&#39; job</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_composite_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                    <span class="c1"># This wasn&#39;t originally a composite method, probably troubleshooted as such</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> \
                                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_directed_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                                <span class="c1"># this is a continuous restricted optimization, spawn the next job in the scan</span>
                                <span class="n">xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_directed_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;brute_force&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">:</span>
                            <span class="c1"># Just terminated a brute_force directed scan job.</span>
                            <span class="c1"># Are there additional jobs of the same type currently running for this species?</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]:</span>
                                <span class="c1"># All brute force scan jobs for these pivots terminated.</span>
                                <span class="n">pivots</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scans</span><span class="p">]</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All brute force directed scan jobs for species </span><span class="si">{label}</span><span class="s1"> between &#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39;pivots </span><span class="si">{pivots}</span><span class="s1"> successfully terminated.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">process_directed_scans</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> <span class="ow">and</span> <span class="s1">&#39;directed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;irc&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;orbitals&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;orbitals&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="c1"># copy the orbitals file to the species / TS output folder</span>
                            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                            <span class="n">orbitals_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitals.fchk&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">,</span> <span class="n">orbitals_path</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="c1"># copy the lennard_jones file to the species output folder (TS&#39;s don&#39;t have L-J data)</span>
                            <span class="n">lj_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                          <span class="s1">&#39;lennard_jones.dat&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">,</span> <span class="n">lj_output_path</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_transport_data</span><span class="p">(</span>
                                    <span class="n">lj_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="s1">&#39;lennard_jones.dat&#39;</span><span class="p">),</span>
                                    <span class="n">opt_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">],</span> <span class="n">bath_gas</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span>
                                    <span class="n">opt_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;ff_param_fit&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="n">mmff94_fallback</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                            <span class="c1"># copy the fitting file to the species output folder</span>
                            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                             <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">)</span>
                            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">,</span> <span class="s1">&#39;gaussian.out&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">ff_param_fit_path</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_md_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">mmff94_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mmff94_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">mmff94_fallback</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Force field parameter fitting job in Gaussian failed. Generating standard &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;MMFF94s conformers instead of fitting a force field for species </span><span class="si">{label}</span><span class="s1">, &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;although its force_field attribute was set to &quot;fit&quot;.&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">=</span> <span class="s1">&#39;MMFF94s&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span><span class="n">n_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span><span class="p">,</span>
                                                                         <span class="n">e_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span><span class="p">,</span>
                                                                         <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                                                                                <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span>
                                                                                                <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                                                                                                <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;gromacs&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> \
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;gromacs&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;gromacs&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_md_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">]):</span>
                    <span class="c1"># This is a TS Species for which conformers haven&#39;t been spawned, and all .success flags</span>
                    <span class="c1"># contain a values (whether ``True`` or ``False``)</span>
                    <span class="c1"># We&#39;re ready to spawn conformer jobs for this TS Species</span>
                    <span class="c1"># Todo: no need to wait for all TSGs before spawning the first opt jobs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_ts_conformer_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>
                                              <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_all_done</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                        <span class="c1"># delete the label only if it represents an empty dictionary</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_list</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># wait 30 sec before bugging the servers again.</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">3600</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Currently running jobs:</span><span class="se">\n</span><span class="si">{self.running_jobs}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># After exiting the Scheduler while loop, append all YAML species not directly calculated to the species_dict:</span>
        <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span></div>

<div class="viewcode-block" id="Scheduler.run_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">conformer</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">max_job_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directed_scan_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">directed_dihedrals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for running (all) jobs.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            xyz (dict): The 3D coordinates for the species.</span>
<span class="sd">            level_of_theory (str or dict): The level of theory to use.</span>
<span class="sd">                                           String format only supports two simple cases:</span>
<span class="sd">                                           (1) method (e.g., cbs-qb3, pm6)</span>
<span class="sd">                                           (2) method/basis (e.g, apfd/def2-tzvp)</span>
<span class="sd">                                           Dictionary format supports more options like dispersion and auxiliary basis</span>
<span class="sd">                                           {&#39;method&#39;: &#39;b3lyp&#39;, &#39;basis&#39;: &#39;def2-svp&#39;, &#39;auxiliary_basis&#39;: &#39;def2-svp/c&#39;,</span>
<span class="sd">                                            &#39;dispersion&#39;: &#39;gd3bj&#39;}</span>
<span class="sd">            job_type (str): The type of job to run.</span>
<span class="sd">            fine (bool, optional): Whether to run an optimization job with a fine grid. `True` to use fine.</span>
<span class="sd">            software (str, optional): An ESS software to use.</span>
<span class="sd">            shift (str, optional): A string representation alpha- and beta-spin orbitals shifts (molpro only).</span>
<span class="sd">            trsh (str, optional): A troubleshooting keyword to be used in input files.</span>
<span class="sd">            memory (int, optional): The total job allocated memory in GB.</span>
<span class="sd">            conformer (int, optional): Conformer number if optimizing conformers.</span>
<span class="sd">            ess_trsh_methods (list, optional): A list of troubleshooting methods already tried out for ESS convergence.</span>
<span class="sd">            scan (list, optional): A list representing atom labels for the dihedral scan</span>
<span class="sd">                                  (e.g., &quot;2 1 3 5&quot; as a string or [2, 1, 3, 5] as a list of integers).</span>
<span class="sd">            pivots (list, optional): The rotor scan pivots, if the job type is scan. Not used directly in these methods,</span>
<span class="sd">                                     but used to identify the rotor.</span>
<span class="sd">            occ (int, optional): The number of occupied orbitals (core + val) from a molpro CCSD sp calc.</span>
<span class="sd">            scan_trsh (str, optional): A troubleshooting method for rotor scans.</span>
<span class="sd">            scan_res (int, optional): The rotor scan resolution in degrees.</span>
<span class="sd">            max_job_time (int, optional): The maximal allowed job time on the server in hours.</span>
<span class="sd">            confs (str, optional): A path to the YAML file conformer coordinates for a Gromacs MD job.</span>
<span class="sd">            radius (float, optional): The species radius in Angstrom.</span>
<span class="sd">            directed_scan_type (str): The type of the directed scan.</span>
<span class="sd">            directed_scans (list): Entries are lists of four-atom dihedral scan indices to constrain.</span>
<span class="sd">            directed_dihedrals (list): The dihedral angles of a directed scan job corresponding to ``directed_scans``.</span>
<span class="sd">            rotor_index (int): The 0-indexed rotor number (key) in the species.rotors_dict dictionary.</span>
<span class="sd">            cpu_cores (int, optional): The total number of cpu cores requested for a job.</span>
<span class="sd">            irc_direction (str, optional): THe direction to run the IRC computation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span>  <span class="c1"># if it&#39;s None, set to default</span>
        <span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span> <span class="k">if</span> <span class="n">ess_trsh_methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="n">pivots</span> <span class="k">if</span> <span class="n">pivots</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="k">if</span> <span class="n">memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>
        <span class="n">checkfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span>  <span class="c1"># defaults to None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level_of_theory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_adaptive_level</span><span class="p">(</span><span class="n">original_level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                                                            <span class="n">heavy_atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_heavy_atoms</span><span class="p">)</span>
        <span class="n">job_level_of_theory_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">format_level_of_theory_inputs</span><span class="p">(</span><span class="n">level_of_theory</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">ess_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">,</span> <span class="n">species_name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                  <span class="n">job_level_of_theory_dict</span><span class="o">=</span><span class="n">job_level_of_theory_dict</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                  <span class="n">charge</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="n">irc_direction</span><span class="p">,</span> <span class="n">solvent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solvent</span><span class="p">,</span>
                  <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">software</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="n">total_job_memory_gb</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span>
                  <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
                  <span class="n">job_additional_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_additional_options</span><span class="p">,</span> <span class="n">job_shortcut_keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_shortcut_keywords</span><span class="p">,</span>
                  <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">max_job_time</span><span class="o">=</span><span class="n">max_job_time</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="n">scan_trsh</span><span class="p">,</span>
                  <span class="n">scan_res</span><span class="o">=</span><span class="n">scan_res</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span> <span class="n">checkfile</span><span class="o">=</span><span class="n">checkfile</span><span class="p">,</span> <span class="n">bath_gas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span>
                  <span class="n">number_of_radicals</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">number_of_radicals</span><span class="p">,</span> <span class="n">conformers</span><span class="o">=</span><span class="n">confs</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                  <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="n">directed_scans</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                  <span class="n">directed_dihedrals</span><span class="o">=</span><span class="n">directed_dihedrals</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="o">=</span><span class="n">cpu_cores</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># this is NOT a conformer DFT job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
                <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="c1"># Jobs of this type haven&#39;t been spawned for label</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Running a conformer DFT job. Append differently to job_dict.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;conformer</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conformer</span><span class="p">))</span>  <span class="c1"># mark as a running job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>  <span class="c1"># save job object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>  <span class="c1"># run the job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">server</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.end_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.end_job">[docs]</a>    <span class="k">def</span> <span class="nf">end_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for checking job status, saving in csv file, and downloading output files.</span>

<span class="sd">        Args:</span>
<span class="sd">            job (Job): The job object.</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job_name (str): The job name from the running_jobs dict.</span>

<span class="sd">        Returns:</span>
<span class="sd">             bool: `True` if job terminated successfully on the server, `False` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">determine_job_status</span><span class="p">()</span>  <span class="c1"># also downloads output file</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Tried to determine status of job </span><span class="si">{0}</span><span class="s1">, but it seems like the job never ran.&#39;</span>
                               <span class="s1">&#39; Re-running job.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;restart_due_to_file_not_found&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;errored&#39;</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;errored&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Job </span><span class="si">{0}</span><span class="s1"> errored because for the second time ARC did not find the output file path </span><span class="si">{1}</span><span class="s1">.&#39;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;restart_due_to_file_not_found&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Did not find the output file of job </span><span class="si">{0}</span><span class="s1"> with path </span><span class="si">{1}</span><span class="s1">. Maybe the job never ran.&#39;</span>
                               <span class="s1">&#39; Re-running job.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;running&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">job</span><span class="o">.</span><span class="n">write_completed_job_to_csv_file</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  Ending job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> (run time: </span><span class="si">{time}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                                                    <span class="n">time</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">))</span> \
                    <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
                <span class="n">check_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">check_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">!=</span> <span class="s1">&#39;conformer&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">check_path</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="o">==</span> <span class="s1">&#39;ess&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rotors_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">rotors_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
                        <span class="n">rotors_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_run_a_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function to run ARC job (used internally).</span>

<span class="sd">        Args:</span>
<span class="sd">            job (Job): The job object.</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                     <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">trsh</span><span class="p">,</span>
                     <span class="n">memory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                     <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">occ</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span>
                     <span class="n">max_job_time</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                     <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_scans</span><span class="p">,</span>
                     <span class="n">directed_dihedrals</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">,</span>
                     <span class="n">irc_direction</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">irc_direction</span><span class="p">)</span>

<div class="viewcode-block" id="Scheduler.run_conformer_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_conformer_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_conformer_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the most stable conformer for each species using molecular dynamics (force fields) and subsequently</span>
<span class="sd">        spawning opt jobs at the conformer level of theory, usually a reasonable yet cheap DFT, e.g., b97d3/6-31+g(d,p).</span>
<span class="sd">        The resulting conformer is saved in a string format xyz in the Species initial_xyz attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (list): Labels of specific species to run conformer jobs for.</span>
<span class="sd">                           If ``None``, conformer jobs will be spawned for all species corresponding to labels in</span>
<span class="sd">                           self.unique_species_labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels_to_consider</span> <span class="o">=</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span>
        <span class="n">log_info_printed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_to_consider</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">])</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span>
                         <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># This is not a TS, opt (/composite) did not converged nor running, and conformer energies were not set.</span>
                <span class="c1"># Also, either &#39;conformers&#39; are set to True in job_types (and it&#39;s not in dont_gen_confs),</span>
                <span class="c1"># or they are set to False (or it&#39;s in dont_gen_confs), but the species has no 3D information.</span>
                <span class="c1"># Generate conformers.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">log_info_printed</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Starting (non-TS) species conformational analysis...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">log_info_printed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
                    <span class="c1"># first run a Gaussian blyp/svp/svpfit job for force field parameters fitting</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">cheap_conformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_cheap_conformer</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_force_field_fit_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">==</span> <span class="s1">&#39;cheap&#39;</span><span class="p">:</span>
                        <span class="c1"># just embed in RDKit and use MMFF94s for opt and energies</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># run the combinatorial method w/o fitting a force field</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span>
                            <span class="n">n_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span><span class="p">,</span>
                            <span class="n">e_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span><span class="p">,</span>
                            <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]:</span>
                <span class="c1"># we&#39;re not running conformer jobs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">:</span>
                    <span class="c1"># the species was defined with xyz&#39;s</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_ts_conformer_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_ts_conformer_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_ts_conformer_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn opt jobs at the ts_guesses level of theory for the TS guesses.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                                     <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                     <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">])</span>
        <span class="n">successful_tsgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tsg</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_tsgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">successful_tsgs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_tsgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="c1"># proceed only if opt (/composite) not already spawned</span>
                <span class="n">rxn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rxn</span> <span class="o">=</span> <span class="s1">&#39; of reaction &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Only one TS guess is available for species </span><span class="si">{0}{1}</span><span class="s1">,&#39;</span>
                            <span class="s1">&#39; using it for geometry optimization&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rxn</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">successful_tsgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">method</span></div>

<div class="viewcode-block" id="Scheduler.run_opt_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_opt_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_opt_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a geometry optimization job. The initial guess is taken from the `initial_xyz` attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not opt jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first opt job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot execute opt job for </span><span class="si">{label}</span><span class="s1"> without xyz (got None for Species.initial_xyz)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span>
                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_composite_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_composite_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_composite_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a composite job (e.g., CBS-QB3) using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Cannot run </span><span class="si">{0}</span><span class="s1"> as a composite method, without specifying a method.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not composite jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first composite job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;composite&#39;</span><span class="p">,</span>
                     <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.run_freq_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_freq_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_freq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a freq job using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        If this was originally a composite job, run an appropriate separate freq job outputting the Hessian.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not freq jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first freq job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;freq&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_sp_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_sp_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_sp_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a single point job using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        If the method is MRCI, first spawn a simple CCSD job, and use orbital determination to run the MRCI job.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine_occ(xyz=self.xyz, charge=self.charge)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> \
                <span class="ow">and</span> <span class="s1">&#39;paths&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;geo&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not running an sp job for </span><span class="si">{label}</span><span class="s1"> at {format_level_of_theory_for_logging(self.sp_level)}, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;since the optimization was done at the same level of theory. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Using the optimization output for parsing the sp energy.&#39;</span><span class="p">)</span>
            <span class="n">recent_opt_job_name</span><span class="p">,</span> <span class="n">recent_opt_job</span> <span class="o">=</span> <span class="s1">&#39;opt_a0&#39;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">opt_job_name</span><span class="p">,</span> <span class="n">opt_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt_job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">recent_opt_job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">recent_opt_job_name</span><span class="p">,</span> <span class="n">recent_opt_job</span> <span class="o">=</span> <span class="n">opt_job_name</span><span class="p">,</span> <span class="n">opt_job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_sp_actions</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">recent_opt_job</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not single point jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first sp job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;run_sp_job() was called for </span><span class="si">{0}</span><span class="s1"> which has a composite method level of theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                <span class="c1"># Parse orbital information from the CCSD job, then run MRCI</span>
                <span class="n">job0</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">job_name_0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">job_name_0</span><span class="p">:</span>
                        <span class="n">job_name_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">job0</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job0</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">core</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;NUMBER OF CORE ORBITALS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="s1">&#39;NUMBER OF VALENCE ORBITALS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="o">*</span> <span class="n">core</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not determine number of core and valence orbitals from CCSD&#39;</span>
                                             <span class="s1">&#39; sp calculation for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">occ</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">core</span>  <span class="c1"># the occupied orbitals are the core and valence orbitals</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;ccsd/vdz&#39;</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># MRCI was requested but no sp job ran for this species, run CCSD first</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;running a CCSD job for </span><span class="si">{label}</span><span class="s1"> before MRCI&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;ccsd/vdz&#39;</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_scan_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_scan_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_scan_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn rotor scan jobs using &#39;final_xyz&#39; for species (or TS).</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_rotors</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> \
                        <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span>
                <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># check that a 1D rotors is not linear</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">())</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])]</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="p">[</span><span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])]</span>
                    <span class="n">v3</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])]</span>
                    <span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span> <span class="o">=</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degs&#39;</span><span class="p">),</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degs&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.15</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="p">[</span><span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">]]):</span>
                        <span class="c1"># this is not a torsional mode, invalidate rotor</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="sa">f</span><span class="s1">&#39;not a torsional mode (angles = </span><span class="si">{angle1:.2f}</span><span class="s1">, </span><span class="si">{angle2:.2f}</span><span class="s1"> degrees)&#39;</span>
                        <span class="k">return</span>
                <span class="n">directed_scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span> \
                    <span class="k">if</span> <span class="s1">&#39;directed_scan_type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                        <span class="c1"># check this job isn&#39;t already running on the server or completed (from a restarted project)</span>
                        <span class="k">if</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                            <span class="c1"># we&#39;re spawning the first brute force scan jobs for this species</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">directed_scan_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">directed_scan_job</span><span class="o">.</span><span class="n">pivots</span> <span class="o">==</span> <span class="n">pivots</span> \
                                    <span class="ow">and</span> <span class="n">directed_scan_job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">directed_pivots</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">directed_pivots</span> <span class="o">==</span> <span class="n">pivots</span> \
                                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">directed_pivots</span><span class="p">]:</span>
                                        <span class="c1"># the previous job hasn&#39;t finished</span>
                                        <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">spawn_directed_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_directed_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># this is a &quot;normal&quot; scan (not directed)</span>
                        <span class="c1"># check this job isn&#39;t already running on the server or completed (from a restarted project)</span>
                        <span class="k">if</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                            <span class="c1"># we&#39;re spawning the first scan job for this species</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">scan_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">scan_job</span><span class="o">.</span><span class="n">pivots</span> <span class="o">==</span> <span class="n">pivots</span> <span class="ow">and</span> <span class="n">scan_job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_irc_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_irc_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_irc_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn an IRC job.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            irc_direction (str): The IRC job direction, either &#39;forward&#39; or &#39;reverse&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irc_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;irc&#39;</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="n">irc_direction</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_orbitals_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_orbitals_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_orbitals_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn orbitals job used for molecular orbital visualization.</span>
<span class="sd">        Currently supporting QChem for printing the orbitals, the output could be visualized using IQMol.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;orbitals&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_onedmin_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_onedmin_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_onedmin_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a lennard-jones calculation using OneDMin.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a Lennard Jones job without the OneDMin software&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;onedmin&#39;</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_force_field_fit_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_force_field_fit_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_force_field_fit_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a force field parameter fitting job (currently only Gaussian is supported for this task).</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">svpfit_output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">svpfit_output_file</span><span class="p">):</span>
            <span class="c1"># a force field parameter fit job was already spawned, use this file</span>
            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">)</span>
            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">,</span> <span class="s1">&#39;gaussian.out&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">svpfit_output_file</span><span class="p">,</span> <span class="n">ff_param_fit_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spawn_md_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a force field parameter fitting job in Gaussian. Gaussian  is missing from &#39;</span>
                         <span class="s1">&#39;the ess_settings dictionary. Generating standard MMFF94s conformers instead for &#39;</span>
                         <span class="s1">&#39;species </span><span class="si">{0}</span><span class="s1">, although its force_field attribute was set to &quot;fit&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">=</span> <span class="s1">&#39;MMFF94s&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span><span class="n">n_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span><span class="p">,</span>
                                                         <span class="n">e_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span><span class="p">,</span>
                                                         <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ff_param_fit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(),</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;blyp/svp/svpfit&#39;</span><span class="p">)</span></div>
                <span class="c1"># todo: this level and theory format (two /) is not compatible with current job level treatment</span>

<div class="viewcode-block" id="Scheduler.run_gromacs_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_gromacs_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_gromacs_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a Gromacs MD job.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            confs (str): The path to a YAML file with array-format coordinates to optimize.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;gromacs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a Gromacs MD job without the Gromacs software&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;gromacs&#39;</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">confs</span><span class="p">,</span>
                         <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.spawn_post_opt_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_post_opt_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_post_opt_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn additional jobs after opt has converged.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job_name (str): The opt job name (used for differetiating between `opt` and `optfreq` jobs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="c1"># This was originally a composite method, probably troubleshooted as &#39;opt&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is an &#39;optfreq&#39; job type, don&#39;t run freq</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;optfreq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_orbitals_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;bde&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">bdes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bde_species_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">scissors</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bde_species</span> <span class="ow">in</span> <span class="n">bde_species_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bde_species</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                    <span class="c1"># H is was added in main</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating the BDE species </span><span class="si">{bde_species.label}</span><span class="s1"> from the original species </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bde_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">bde_species</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">bde_species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{bde_species.label}</span><span class="s1"> is monoatomic&#39;</span><span class="p">)</span>
                        <span class="c1"># No need to run opt/freq jobs for a monoatomic species, only run sp (or composite if relevant)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># determine the lowest energy conformation of radicals generated in BDE calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">bde_species_list</span>
                                            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.spawn_directed_scan_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_directed_scan_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_directed_scan_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn directed scan jobs.</span>
<span class="sd">        Directed scan types could be one of the following: &#39;brute_force_sp&#39;, &#39;brute_force_opt&#39;, &#39;cont_opt&#39;,</span>
<span class="sd">        &#39;brute_force_sp_diagonal&#39;, &#39;brute_force_opt_diagonal&#39;, or &#39;cont_opt_diagonal&#39;.</span>
<span class="sd">        Here we treat ``cont`` and ``brute_force`` separately, and also consider the ``diagonal`` keyword.</span>
<span class="sd">        The differentiation between ``sp`` and ``opt`` is done in the Job module.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            rotor_index (int): The 0-indexed rotor number (key) in the species.rotors_dict dictionary.</span>
<span class="sd">            xyz (str, optional): The 3D coordinates for a continuous directed scan.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InputError: If the species directed scan type has an unexpected value,</span>
<span class="sd">                        or if ``xyz`` wasn&#39;t given for a cont_opt job.</span>
<span class="sd">            SchedulerError: If the rotor scan resolution as defined in settings.py is illegal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">rotor_scan_resolution</span>
        <span class="k">if</span> <span class="nb">divmod</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="n">increment</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The directed scan got an illegal scan resolution of </span><span class="si">{increment}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span>
        <span class="n">directed_scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span> <span class="ow">and</span> <span class="s1">&#39;brute&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span> <span class="ow">and</span> <span class="s1">&#39;ess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;directed_scan_type must be either continuous or brute force, got: </span><span class="si">{directed_scan_type}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ess&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="c1"># allow the ESS to control the scan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                         <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="n">scans</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                         <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;brute&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="c1"># spawn jobs all at once</span>
            <span class="n">dihedrals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                <span class="n">original_dihedral</span> <span class="o">=</span> <span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scan</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">original_dihedral</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span>
                                                <span class="k">if</span> <span class="n">original_dihedral</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span> <span class="o">&lt;=</span> <span class="mf">180.0</span>
                                                <span class="k">else</span> <span class="n">original_dihedral</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span> <span class="o">-</span> <span class="mf">360.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="n">increment</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">modified_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="k">if</span> <span class="s1">&#39;diagonal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                <span class="c1"># increment dihedrals one by one (resulting in an ND scan)</span>
                <span class="n">all_dihedral_combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scan</span><span class="p">)]</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">dihedral_tuple</span> <span class="ow">in</span> <span class="n">all_dihedral_combinations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">scan</span><span class="p">,</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span> <span class="n">dihedral_tuple</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                              <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">)</span>
                        <span class="n">modified_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span> <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                                 <span class="n">directed_scans</span><span class="o">=</span><span class="n">scans</span><span class="p">,</span> <span class="n">directed_dihedrals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dihedral_tuple</span><span class="p">),</span>
                                 <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># increment all dihedrals at once (resulting in a unique 1D scan along several changing dimensions)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])])):</span>
                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                        <span class="n">dihedral</span> <span class="o">=</span> <span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scan</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                              <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">)</span>
                        <span class="n">modified_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
                    <span class="n">directed_dihedrals</span> <span class="o">=</span> <span class="p">[</span><span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scan</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span> <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                                 <span class="n">directed_scans</span><span class="o">=</span><span class="n">scans</span><span class="p">,</span> <span class="n">directed_dihedrals</span><span class="o">=</span><span class="n">directed_dihedrals</span><span class="p">,</span>
                                 <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="c1"># spawn jobs one by one</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                     <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]]</span>  <span class="c1"># stores as str for YAML</span>
            <span class="n">rotor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">]</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span>
            <span class="n">pivots</span> <span class="o">=</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span>
            <span class="n">max_num</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">increment</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># dihedral angles per scan</span>
            <span class="n">original_dihedrals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]:</span>
                <span class="n">f_dihedral</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
                <span class="n">original_dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_dihedral</span> <span class="k">if</span> <span class="n">f_dihedral</span> <span class="o">&lt;</span> <span class="mf">180.0</span> <span class="k">else</span> <span class="n">f_dihedral</span> <span class="o">-</span> <span class="mf">360.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]):</span>
                <span class="c1"># this is the first call for this cont_opt directed rotor, spawn the first job w/o changing dihedrals</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span> <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="n">scans</span><span class="p">,</span>
                             <span class="n">directed_dihedrals</span><span class="o">=</span><span class="n">original_dihedrals</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this is NOT the first call for this cont_opt directed rotor, check that ``xyz`` was given.</span>
                <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># xyz is None only at the first time cont opt is spawned, where cont_index is [0, 0,... 0].</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;xyz argument must be given for a continuous scan job&#39;</span><span class="p">)</span>
                <span class="c1"># check whether this rotor is done</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 0-indexed</span>
                    <span class="c1"># no more counters to increment, all done!</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Completed all jobs for the continuous directed rotor scan for species </span><span class="si">{label}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;between pivots </span><span class="si">{pivots}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_directed_scans</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">modified_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">dihedrals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">original_dihedral</span><span class="p">,</span> <span class="n">scan_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">original_dihedrals</span><span class="p">,</span> <span class="n">scans</span><span class="p">)):</span>
                <span class="n">dihedral</span> <span class="o">=</span> <span class="n">original_dihedral</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">increment</span>
                <span class="c1"># change the original dihedral so we won&#39;t end up with two calcs for 180.0, but none for -180.0</span>
                <span class="c1"># (it only matters for plotting, the geometry is of course the same)</span>
                <span class="n">dihedral</span> <span class="o">=</span> <span class="n">dihedral</span> <span class="k">if</span> <span class="n">dihedral</span> <span class="o">&lt;=</span> <span class="mf">180.0</span> <span class="k">else</span> <span class="n">dihedral</span> <span class="o">-</span> <span class="mf">360.0</span>
                <span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
                <span class="c1"># Only change the dihedrals in the xyz if this torsion corresponds to the current index,</span>
                <span class="c1"># or if this is a diagonal scan.</span>
                <span class="c1"># Species.set_dihedral() uses .final_xyz or the given xyz to modify the .initial_xyz</span>
                <span class="c1"># attribute to the desired dihedral.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan_</span><span class="p">,</span> <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">)</span>
                <span class="n">modified_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span> <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="n">scans</span><span class="p">,</span>
                         <span class="n">directed_dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;diagonal&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                <span class="c1"># increment ALL counters for a diagonal scan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># increment the counter sequentially (non-diagonal scan)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_num</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Scheduler.spawn_md_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_md_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_md_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">prev_conf_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Embed conformers and run a molecular dynamics optimization using a fitted force field.</span>
<span class="sd">        Then generate conformers using combinations of the detected torsion wells, and re-run until converging.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            prev_conf_list (list, optional): The previous conformers (entries are two length lists, not dicts).</span>
<span class="sd">                                             If not given, a first Gromacs job will be spawned.</span>
<span class="sd">            num_confs (int, optional): The number of conformers to generate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">determine_rotors</span><span class="p">()</span>
        <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">])</span>
            <span class="n">tops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">prev_conf_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># first time spawning MD jobs for this species</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">conformers</span><span class="o">.</span><span class="n">update_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                                                     <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">]</span>
                <span class="n">number_of_heavy_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span>
                                             <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_non_hydrogen</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
                <span class="n">number_of_heavy_atoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">symbol</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">])</span>
            <span class="n">num_confs</span> <span class="o">=</span> <span class="n">num_confs</span> \
                        <span class="ow">or</span> <span class="n">conformers</span><span class="o">.</span><span class="n">determine_number_of_conformers_to_generate</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="o">=</span><span class="n">number_of_heavy_atoms</span><span class="p">,</span>
                                                                                 <span class="n">torsion_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">),</span>
                                                                                 <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">:</span>
                <span class="c1"># embed conformers (but don&#39;t optimize)</span>
                <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">embed_rdkit</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="n">num_confs</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
                    <span class="n">conf</span><span class="p">,</span> <span class="n">coord</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
                    <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">embedded_confs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                               <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;embedded_conformers.yml&#39;</span><span class="p">)</span>  <span class="c1"># list of lists</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">embedded_confs_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_gromacs_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">embedded_confs_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># a previous Gromacs job was submitted, generate specific conformers via deduce_new_conformers()</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">confs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                      <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers.yml&#39;</span><span class="p">)</span>  <span class="c1"># list of dicts</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">confs_path</span><span class="p">):</span>
                <span class="n">confs</span> <span class="o">=</span> <span class="n">read_yaml_file</span><span class="p">(</span><span class="n">confs_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">prev_conf</span> <span class="ow">in</span> <span class="n">prev_conf_list</span><span class="p">:</span>
                <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">prev_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="n">prev_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;Gromacs&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)})</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">confs_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">confs</span><span class="p">)</span>  <span class="c1"># save for the next iteration and for archiving</span>

            <span class="n">confs</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">determine_dihedrals</span><span class="p">(</span><span class="n">confs</span><span class="p">,</span> <span class="n">torsions</span><span class="p">)</span>
            <span class="n">new_conformers</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">deduce_new_conformers</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">conformers</span><span class="o">=</span><span class="n">confs</span><span class="p">,</span> <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                                                              <span class="n">tops</span><span class="o">=</span><span class="n">tops</span><span class="p">,</span> <span class="n">mol_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span>
                                                              <span class="n">plot_path</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_confs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                          <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;new_conformers.yml&#39;</span><span class="p">)</span>  <span class="c1"># list of lists</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_conf</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">new_conf</span> <span class="ow">in</span> <span class="n">new_conformers</span><span class="p">]</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">new_confs_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_gromacs_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">new_confs_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.process_directed_scans"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.process_directed_scans">[docs]</a>    <span class="k">def</span> <span class="nf">process_directed_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process all directed rotors for a species and check the quality of the scan.</span>

<span class="sd">        rotors_dict structure (attribute of ARCSpecies)::</span>

<span class="sd">            rotors_dict: {1: {&#39;pivots&#39;: ``list``,</span>
<span class="sd">                              &#39;top&#39;: ``list``,</span>
<span class="sd">                              &#39;scan&#39;: ``list``,</span>
<span class="sd">                              &#39;number_of_running_jobs&#39;: ``int``,</span>
<span class="sd">                              &#39;success&#39;: ``bool``,</span>
<span class="sd">                              &#39;invalidation_reason&#39;: ``str``,</span>
<span class="sd">                              &#39;times_dihedral_set&#39;: ``int``,</span>
<span class="sd">                              &#39;scan_path&#39;: &lt;path to scan output file&gt;,</span>
<span class="sd">                              &#39;max_e&#39;: ``float``,  # in kJ/mol,</span>
<span class="sd">                              &#39;symmetry&#39;: ``int``,</span>
<span class="sd">                              &#39;dimensions&#39;: ``int``,</span>
<span class="sd">                              &#39;original_dihedrals&#39;: ``list``,</span>
<span class="sd">                              &#39;cont_indices&#39;: ``list``,</span>
<span class="sd">                              &#39;directed_scan_type&#39;: ``str``,</span>
<span class="sd">                              &#39;directed_scan&#39;: ``dict``,  # keys: tuples of dihedrals as strings,</span>
<span class="sd">                                                          # values: dicts of energy, xyz, is_isomorphic, trsh</span>
<span class="sd">                             }</span>
<span class="sd">                          2: {}, ...</span>
<span class="sd">                         }</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            pivots (list): The rotor pivots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rotor_dict_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rotor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_dict_index</span><span class="p">]</span>  <span class="c1"># avoid modifying the iterator</span>
            <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pivots</span><span class="p">:</span>
                <span class="c1"># identified a directed scan (either continuous or brute force, they&#39;re treated the same here)</span>
                <span class="n">dihedrals</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">dihedral_string_tuple</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">dihedral_string_tuple</span> <span class="ow">in</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">sorted_dihedrals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dihedrals</span><span class="p">)</span>
                <span class="n">min_energy</span> <span class="o">=</span> <span class="n">extermum_list</span><span class="p">([</span><span class="n">directed_scan_dihedral</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
                                            <span class="k">for</span> <span class="n">directed_scan_dihedral</span> <span class="ow">in</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                           <span class="n">return_min</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">trshed_points</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ess&#39;</span><span class="p">:</span>
                    <span class="c1"># parse the single output file</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_nd_scan_energies</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">:</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;scans&#39;</span><span class="p">:</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;directed_scan&#39;</span><span class="p">:</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]}</span>
                    <span class="k">for</span> <span class="n">dihedral_list</span> <span class="ow">in</span> <span class="n">sorted_dihedrals</span><span class="p">:</span>
                        <span class="n">dihedrals_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">dihedral_list</span><span class="p">)</span>
                        <span class="n">dihedral_dict</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">dihedrals_key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">dihedral_dict</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]:</span>
                            <span class="n">trshed_points</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">dihedral_dict</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">dihedral_dict</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">min_energy</span>  <span class="c1"># set 0 at the minimal energy</span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                <span class="n">rotor_yaml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">.yml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pivots</span><span class="p">,</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]))</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">save_nd_rotor_yaml</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_yaml_file_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_dict_index</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotor_yaml_file_path</span>
                <span class="k">if</span> <span class="n">trshed_points</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Directed rotor scan for species </span><span class="si">{label}</span><span class="s1"> between pivots </span><span class="si">{rotor_dict[&quot;pivots&quot;]}</span><span class="s1"> &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;had </span><span class="si">{trshed_points}</span><span class="s1"> points that required optimization troubleshooting.&#39;</span><span class="p">)</span>
                <span class="n">rotor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;scans&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># plot 1D rotor</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">plot_1d_rotor_scan</span><span class="p">(</span>
                        <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">original_dihedral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_dict_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;scans&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># plot 2D rotor</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">plot_2d_rotor_scan</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;not plotting ND rotors with N &gt; 2&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.process_conformers"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.process_conformers">[docs]</a>    <span class="k">def</span> <span class="nf">process_conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the generated conformers and spawn DFT jobs at the conformer_level.</span>
<span class="sd">        If more than one conformer is available, they will be optimized at the DFT conformer_level.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                     <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                     <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># before optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers_before_opt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only one conformer is available for species </span><span class="si">{label}</span><span class="s1">, using it as initial xyz.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># check whether this conformer is isomorphic to the species 2D graph representation</span>
                <span class="c1"># (since this won&#39;t be checked in determine_most_stable_conformer, as there&#39;s only one)</span>
                <span class="n">is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span>
                                               <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                               <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
                    <span class="n">b_mol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                        <span class="c1"># we&#39;ll optimize the single conformer even if it is not isomorphic with the 2D graph</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The single conformer </span><span class="si">{label}</span><span class="s1"> could not be checked for isomorphism with the 2D &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;graph representation {self.species_dict[label].mol.copy(deep=True).to_smiles()}.&#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39; Optimizing this conformer anyway.&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Isomorphism check cannot be done for charged species </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Single conformer could not be checked for isomorphism; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The only conformer for species </span><span class="si">{label}</span><span class="s1"> could not be checked for isomorphism &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;{self.species_dict[label].mol.copy(deep=True).to_smiles()}. NOT calculating &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;this species. To change this behaviour, pass `allow_nonisomorphic_2d = True`.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="n">check_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">b_mol</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine isomorphism for species </span><span class="si">{label}</span><span class="s1">. &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;Got the following error:</span><span class="se">\n</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">b_mol</span><span class="p">):</span>
                            <span class="c1"># this is still considered isomorphic</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The only conformer for species </span><span class="si">{label}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation {b_mol.copy(deep=True).to_smiles()}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;single conformer passed isomorphism check; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The only conformer for species </span><span class="si">{label}</span><span class="s1"> is not isomorphic &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation {b_mol.copy(deep=True).to_smiles()}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">b_mol</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using this conformer anyway (it is compliant with the 2D graph)&#39;</span><span class="p">)</span>
                            <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using this conformer anyway (allow_nonisomorphic_2d was set to True)&#39;</span><span class="p">)</span>
                            <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not using this conformer (to change this behavior, set allow_nonisomorphic_2d &#39;</span>
                                        <span class="s1">&#39;to True)&#39;</span><span class="p">)</span>
                            <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">spawn_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># opt wasn&#39;t requested, skip directly to additional relevant job types</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_orbitals_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.parse_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">parse_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse E0 (kJ/mol) from the conformer opt output file.</span>
<span class="sd">        For species, save it in the Species.conformer_energies attribute.</span>
<span class="sd">        Fot TSs, save it in the TSGuess.energy attribute, and also parse the geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            job (Job): The conformer job object.</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">            i (int): The conformer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_geometry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for TSGuess </span><span class="si">{i}</span><span class="s1"> of </span><span class="si">{label}</span><span class="s1"> is </span><span class="si">{energy:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for TSGuess </span><span class="si">{i}</span><span class="s1"> of </span><span class="si">{label}</span><span class="s1"> is None&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for conformer </span><span class="si">{i}</span><span class="s1"> of </span><span class="si">{label}</span><span class="s1"> is </span><span class="si">{energy:.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for conformer </span><span class="si">{i}</span><span class="s1"> of </span><span class="si">{label}</span><span class="s1"> is None&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Conformer </span><span class="si">{i}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> did not converge!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.determine_most_stable_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_most_stable_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">determine_most_stable_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the most stable conformer for a species (which is not a TS).</span>
<span class="sd">        Also run an isomorphism check.</span>
<span class="sd">        Save the resulting xyz as `initial_xyz`.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The determine_most_stable_conformer() method does not deal with transition&#39;</span>
                                 <span class="s1">&#39; state guesses.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No conformer converged for species </span><span class="si">{label}</span><span class="s1">! Trying to troubleshoot conformer jobs...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">xyzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">:</span>
                <span class="n">xyzs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">))</span>
            <span class="n">xyzs_in_original_order</span> <span class="o">=</span> <span class="n">xyzs</span>
            <span class="n">energies</span><span class="p">,</span> <span class="n">xyzs</span> <span class="o">=</span> <span class="n">sort_two_lists_by_the_first</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">,</span> <span class="n">xyzs</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                         <span class="n">xyzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                         <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                         <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">energies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">)</span>  <span class="c1"># after optimization</span>
            <span class="c1"># Run isomorphism checks if a 2D representation is available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzs</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                   <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
                        <span class="n">b_mol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="n">check_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">b_mol</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> \
                                    <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine isomorphism for charged species </span><span class="si">{label}</span><span class="s1">. &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;Optimizing the most stable conformer anyway. Got the &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine isomorphism for species </span><span class="si">{label}</span><span class="s1">. Got the &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">is_isomorphic</span> <span class="ow">or</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Most stable conformer for species </span><span class="si">{label}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation {b_mol.copy(deep=True).to_smiles()}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                                <span class="k">if</span> <span class="s1">&#39;passed isomorphism check&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;most stable conformer (</span><span class="si">{i}</span><span class="s1">) passed &#39;</span> \
                                                                        <span class="sa">f</span><span class="s1">&#39;isomorphism check; &#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                             <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                             <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A conformer for species </span><span class="si">{label}</span><span class="s1"> was found to be isomorphic with the &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;2D graph representation &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;{self.species_dict[label].mol.copy(deep=True).to_smiles()}. &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;This conformer is {energies[i] - energies[0]:.2f} kJ/mol above the &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;most stable one which corresponds to &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;{mol.copy(deep=True).to_smiles()} (and is not isomorphic). &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;Using the isomorphic conformer for further geometry optimization.&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Conformer </span><span class="si">{i}</span><span class="s1"> was found to be the lowest &#39;</span> \
                                                                        <span class="sa">f</span><span class="s1">&#39;energy isomorphic conformer; &#39;</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                            <span class="k">if</span> <span class="s1">&#39;Conformers optimized and compared&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                                    <span class="sa">f</span><span class="s1">&#39;Conformers optimized and compared at &#39;</span> \
                                    <span class="sa">f</span><span class="s1">&#39;{format_level_of_theory_for_logging(self.conformer_level)}; &#39;</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;most stable conformer (</span><span class="si">{i}</span><span class="s1">) did not &#39;</span> \
                                                                    <span class="sa">f</span><span class="s1">&#39;pass isomorphism check; &#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Most stable conformer for species </span><span class="si">{label}</span><span class="s1"> with structure &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;{b_mol.copy(deep=True).to_smiles()} was found to be NON-isomorphic &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;{self.species_dict[label].mol.copy(deep=True).to_smiles()}. &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;Searching for a different conformer that is isomorphic...&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># all conformers for the species failed isomorphism test</span>
                    <span class="n">smiles_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                       <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">())</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">SanitizationError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Could not perceive molecule&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                        <span class="c1"># we&#39;ll optimize the most stable conformer even if it is not isomorphic to the 2D graph</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No conformer for </span><span class="si">{label}</span><span class="s1"> was found to be isomorphic with the 2D graph &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;representation {self.species_dict[label].mol.copy(deep=True).to_smiles()} &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;(got: </span><span class="si">{smiles_list}</span><span class="s1">).  Optimizing the most stable conformer anyway.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;No conformer was found to be isomorphic with &#39;</span> \
                                                            <span class="s1">&#39;the 2D graph representation; &#39;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Isomorphism check cannot be done for charged species </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># troubleshoot when all conformers of a species failed isomorphic test</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Isomorphism check for all conformers of species </span><span class="si">{label}</span><span class="s1"> failed at &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;{format_level_of_theory_for_logging(self.conformer_level)}. &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;Attempting to troubleshoot using a different level.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                            <span class="sa">f</span><span class="s1">&#39;Error: No conformer was found to be isomorphic with the 2D graph representation at &#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;{format_level_of_theory_for_logging(self.conformer_level)}; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_conformer_isomorphism</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not run isomorphism check for species </span><span class="si">{label}</span><span class="s1"> due to missing 2D graph &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;representation. Using the most stable conformer for further geometry optimization.&#39;</span><span class="p">)</span>
                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">conformer_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">conformer_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">most_stable_conformer</span> <span class="o">=</span> <span class="n">xyzs_in_original_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">conformer_xyz</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Conformer number {xyzs_in_original_order.index(conformer_xyz)} for species </span><span class="si">{label}</span><span class="s1"> is &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;used for geometry optimization.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.determine_most_likely_ts_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_most_likely_ts_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the most likely TS conformer.</span>
<span class="sd">        Save the resulting xyz as `initial_xyz`.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;determine_most_likely_ts_conformer() method only processes transition state guesses.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All TS guesses for </span><span class="si">{label}</span><span class="s1"> terminated.&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> All methods were successful: </span><span class="si">{self.species_dict[label].successful_methods}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; Successful methods: </span><span class="si">{self.species_dict[label].successful_methods}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; Geometry parsed from YAML file.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; No method has converged!&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No TS methods for </span><span class="si">{label}</span><span class="s1"> have converged!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; Unsuccessful methods: </span><span class="si">{self.species_dict[label].unsuccessful_methods}</span><span class="s1">&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No guess converged for TS </span><span class="si">{label}</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="c1"># for i, job in self.job_dict[label][&#39;conformers&#39;].items():</span>
            <span class="c1">#     self.troubleshoot_ess(label, job, level_of_theory=job.level_of_theory,</span>
            <span class="c1">#                           conformer=job.conformer)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># currently we take the most stable guess. We&#39;ll need to implement additional checks here:</span>
            <span class="c1"># - normal displacement mode of the imaginary frequency</span>
            <span class="c1"># - IRC isomorphism checks</span>
            <span class="n">rxn_txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span> \
                <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; of reaction </span><span class="si">{self.species_dict[label].rxn_label}</span><span class="s1">&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Geometry *guesses* of successful TS guesses for </span><span class="si">{label}{rxn_txt}</span><span class="s1">:&#39;</span><span class="p">)</span>
            <span class="n">e_min</span> <span class="o">=</span> <span class="n">extermum_list</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span> <span class="n">return_min</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">==</span> <span class="n">e_min</span><span class="p">:</span>
                    <span class="n">i_min</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">i_min</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="o">=</span> <span class="n">i_min</span>  <span class="c1"># change this if selecting a better TS later</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_method</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method</span>  <span class="c1"># change if selecting a better TS later</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># guess method and ts_level opt were both successful</span>
                    <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">-=</span> <span class="n">e_min</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS guess </span><span class="si">{tsg.index}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">. Method: </span><span class="si">{tsg.method}</span><span class="s1">, relative energy: &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{tsg.energy:.2f}</span><span class="s1"> kJ/mol, guess execution time: </span><span class="si">{tsg.execution_time}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not pair most stable conformer </span><span class="si">{i_min}</span><span class="s1"> of </span><span class="si">{label}</span><span class="s1"> to a respective &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;TS guess&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                         <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                                         <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                         <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                                         <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.parse_composite_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_composite_geo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_composite_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a &#39;composite&#39; job converged successfully, and parse the geometry into `final_xyz`.</span>
<span class="sd">        Also checks (QA) that no imaginary frequencies were assigned for stable species,</span>
<span class="sd">        and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        Returns ``True`` if the job converged successfully, ``False`` otherwise and troubleshoots.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The composite job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;parsing composite geo for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
        <span class="n">freq_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># all composite jobs are fine if fine was asked for</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span>
            <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39; of reaction </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimized geometry for </span><span class="si">{label}{rxn_str}</span><span class="s1"> at &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;{format_level_of_theory_for_logging(job.job_level_of_theory_dict)}:</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;{xyz_to_str(xyz_dict=self.species_dict[label].final_xyz)}&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="c1"># Check frequencies (using cclib crashes for CBS-QB3 output, so using an explicit parser here)</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_frequencies</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
            <span class="n">freq_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="o">=</span><span class="n">frequencies</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># run freq / scan jobs on this optimized geometry</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                        <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite passed isomorphism check; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite did not pass isomorphism check; &#39;</span>
                    <span class="n">success</span> <span class="o">&amp;=</span> <span class="n">is_isomorphic</span>
                <span class="k">return</span> <span class="n">success</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">freq_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># return ``False``, so no freq / scan jobs are initiated for this unoptimized geometry</span></div>

<div class="viewcode-block" id="Scheduler.parse_opt_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_opt_geo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_opt_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that an &#39;opt&#39; or &#39;optfreq&#39; job converged successfully, and parse the geometry into `final_xyz`.</span>
<span class="sd">        If the job is &#39;optfreq&#39;, also checks (QA) that no imaginary frequencies were assigned for stable species,</span>
<span class="sd">        and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        Returns ``True`` if the job (or both jobs) converged successfully, ``False`` otherwise and troubleshoots opt.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The optimization job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;parsing opt geo for </span><span class="si">{job.job_name}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="c1"># Run opt again using a finer grid.</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">xyz</span>  <span class="c1"># save for troubleshooting, since trsh goes by initial</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;optfreq&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="n">format_level_of_theory_for_logging</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">)</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">save_geo</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39; of reaction </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                    <span class="c1"># This is the final geometry of a stable species. Determine whether the species participates in</span>
                    <span class="c1"># a reaction (or several), if so update its geometry in the respective Species representing the</span>
                    <span class="c1"># reaction&#39;s TS</span>
                    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
                        <span class="n">reactant</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reactants</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="n">product</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">products</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">reactant</span> <span class="ow">or</span> <span class="n">product</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">reactant</span> <span class="ow">and</span> \
                                        <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">reactant_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">reactant_xyz</span> <span class="ow">in</span> <span class="n">tsg</span><span class="o">.</span><span class="n">reactants_xyz</span><span class="p">]):</span>
                                    <span class="c1"># This species is a reactant of rxn,</span>
                                    <span class="c1"># and its geometry wasn&#39;t saved in the TSGuess objects</span>
                                    <span class="n">tsg</span><span class="o">.</span><span class="n">reactants_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">product</span> <span class="ow">and</span> \
                                        <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">product_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">product_xyz</span> <span class="ow">in</span> <span class="n">tsg</span><span class="o">.</span><span class="n">products_xyz</span><span class="p">]):</span>
                                    <span class="c1"># This species is a product of rxn,</span>
                                    <span class="c1"># and its geometry wasn&#39;t saved in the TSGuess objects</span>
                                    <span class="n">tsg</span><span class="o">.</span><span class="n">products_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimized geometry for </span><span class="si">{label}{rxn}</span><span class="s1"> at </span><span class="si">{level}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{xyz}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">rxn</span><span class="o">=</span><span class="n">rxn_str</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">format_level_of_theory_for_logging</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">),</span>
                    <span class="n">xyz</span><span class="o">=</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>  <span class="c1"># will be overwritten with freq</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
                    <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                        <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;opt passed isomorphism check&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt passed isomorphism check; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt did not pass isomorphism check; &#39;</span>
                    <span class="n">success</span> <span class="o">&amp;=</span> <span class="n">is_isomorphic</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_opt_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># run freq / sp / scan jobs on this optimized geometry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># return ``False``, so no freq / sp / scan jobs are initiated for this unoptimized geometry</span></div>

<div class="viewcode-block" id="Scheduler.check_freq_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_freq_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_freq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a freq job converged successfully. Also checks (QA) that no imaginary frequencies were assigned for</span>
<span class="sd">        stable species, and that exactly one imaginary frequency was assigned for a TS.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The frequency job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Called check_freq_job with no output file&#39;</span><span class="p">)</span>
            <span class="n">vibfreqs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_frequencies</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
            <span class="n">freq_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="o">=</span><span class="n">vibfreqs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="c1"># copy the frequency file to the species / TS output folder</span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                <span class="n">freq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;freq.out&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">freq_path</span><span class="p">)</span>
                <span class="c1"># set species.polarizability</span>
                <span class="n">polarizability</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_polarizability</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">polarizability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">polarizability</span> <span class="o">=</span> <span class="p">(</span><span class="n">polarizability</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;angstroms^3&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Polarizability calculated at the </span><span class="si">{0}</span><span class="s1"> level of theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Polarizability calculated at the </span><span class="si">{0}</span><span class="s1"> level of theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_negative_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_negative_freq">[docs]</a>    <span class="k">def</span> <span class="nf">check_negative_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for determining the number of negative frequencies. Also logs appropriate errors.</span>
<span class="sd">        Returns ``True`` if the number of negative frequencies is as excepted, ``False`` otherwise.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The optimization job object.</span>
<span class="sd">            vibfreqs (list): The vibrational frequencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neg_freqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">vibfreqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neg_freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{label}</span><span class="s1"> has {len(neg_freqs)} imaginary frequencies (</span><span class="si">{neg_freqs}</span><span class="s1">), should have exactly 1.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;{len(neg_freqs)} imaginary freqs for&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Warning: {len(neg_freqs)} imaginary freqs for TS (</span><span class="si">{neg_freqs}</span><span class="s1">); &#39;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{label}</span><span class="s1"> has {len(neg_freqs)} imaginary frequencies (</span><span class="si">{neg_freqs}</span><span class="s1">), &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;should have exactly 0.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;{len(neg_freqs)} imaginary freq for&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Warning: {len(neg_freqs)} imaginary freq for stable species &#39;</span> \
                                                  <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{neg_freqs}</span><span class="s1">); &#39;</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{label}</span><span class="s1"> has exactly one imaginary frequency: </span><span class="si">{neg_freqs[0]}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Imaginary frequency: </span><span class="si">{neg_freqs[0]}</span><span class="s1">; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.check_sp_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_sp_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_sp_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a single point job converged successfully.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The single point job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="ow">and</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">:</span>
            <span class="c1"># This is a CCSD job ran before MRCI. Spawn MRCI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_sp_actions</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
            <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># save the geometry from the sp job for monoatomic species for which no opt/freq jobs will be spawned</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.post_sp_actions"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.post_sp_actions">[docs]</a>    <span class="k">def</span> <span class="nf">post_sp_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform post-sp actions.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The single point job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;ccsd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_t1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">])</span>
        <span class="n">zpe_scale_factor</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cbs-qb3&#39;</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">e_elect</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
                                                                <span class="n">zpe_scale_factor</span><span class="o">=</span><span class="n">zpe_scale_factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;. Looks like it requires multireference treatment, I wouldn&#39;t trust it&#39;s calculated energy!&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">&gt;</span> <span class="mf">0.015</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;. It might have multireference characteristic.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{label}</span><span class="s1"> has a T1 diagnostic parameter of </span><span class="si">{self.species_dict[label].t1}{txt}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;T1 = </span><span class="si">{self.species_dict[label].t1}</span><span class="s1">; &#39;</span></div>

<div class="viewcode-block" id="Scheduler.check_irc_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_irc_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_irc_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check an IRC job and perform post-job tasks.</span>

<span class="sd">        Todo:</span>
<span class="sd">            Need to check isomorphism</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The single point job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_irc_traj_animation</span><span class="p">(</span><span class="n">irc_f_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">irc_r_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;irc_traj.gjf&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Scheduler.check_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a rotor scan job converged successfully. Also checks (QA) whether the scan is relatively &quot;smooth&quot;,</span>
<span class="sd">        and whether the optimized geometry indeed represents the minimum energy conformer.</span>
<span class="sd">        Recommends whether or not to use this rotor using the &#39;successful_rotors&#39; and &#39;unsuccessful_rotors&#39; attributes.</span>
<span class="sd">        rotors_dict structure (attribute of ARCSpecies)::</span>

<span class="sd">            rotors_dict: {1: {&#39;pivots&#39;: ``list``,</span>
<span class="sd">                              &#39;top&#39;: ``list``,</span>
<span class="sd">                              &#39;scan&#39;: ``list``,</span>
<span class="sd">                              &#39;number_of_running_jobs&#39;: ``int``,</span>
<span class="sd">                              &#39;success&#39;: ``bool``,</span>
<span class="sd">                              &#39;invalidation_reason&#39;: ``str``,</span>
<span class="sd">                              &#39;times_dihedral_set&#39;: ``int``,</span>
<span class="sd">                              &#39;scan_path&#39;: &lt;path to scan output file&gt;,</span>
<span class="sd">                              &#39;max_e&#39;: ``float``,  # in kJ/mol,</span>
<span class="sd">                              &#39;symmetry&#39;: ``int``,</span>
<span class="sd">                              &#39;dimensions&#39;: ``int``,</span>
<span class="sd">                              &#39;original_dihedrals&#39;: ``list``,</span>
<span class="sd">                              &#39;cont_indices&#39;: ``list``,</span>
<span class="sd">                              &#39;directed_scan_type&#39;: ``str``,</span>
<span class="sd">                              &#39;directed_scan&#39;: ``dict``,  # keys: tuples of dihedrals as strings,</span>
<span class="sd">                                                          # values: dicts of energy, xyz, is_isomorphic, trsh</span>
<span class="sd">                             }</span>
<span class="sd">                          2: {}, ...</span>
<span class="sd">                         }</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The rotor scan job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the job has not converged, troubleshoot</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">invalidate</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_rotors</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
                <span class="n">energies</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_1d_scan_energies</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>  <span class="c1"># in kJ/mol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">torsion</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degs&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">energies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;Could not read energies&#39;</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Energies from rotor scan of </span><span class="si">{label}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> could not &#39;</span> \
                              <span class="s1">&#39;be read. Invalidating rotor.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">scan_quality_check</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span>
                    <span class="n">used_methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">):</span>
                    <span class="c1"># the rotor scan is problematic, troubleshooting is required</span>
                    <span class="k">if</span> <span class="s1">&#39;change conformer&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                        <span class="c1"># a lower conformation was found</span>
                        <span class="n">deg_increment</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span>
                            <span class="n">scan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                            <span class="n">deg_increment</span><span class="o">=</span><span class="n">deg_increment</span><span class="p">)</span>
                        <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                            <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">,</span>
                            <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="c1"># Remove all completed rotor calculation information</span>
                            <span class="k">for</span> <span class="n">rotor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">rotor</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="c1"># re-run opt (or composite) on the new initial_xyz with the desired dihedral</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># The conformer is wrong, and changing the dihedral resulted in a non-isomorphic species.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                                <span class="sa">f</span><span class="s1">&#39;A lower conformer was found for </span><span class="si">{label}</span><span class="s1"> via a torsion mode, but it is not &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;isomorphic with the 2D graph representation &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;{self.species_dict[label].mol.copy(deep=True).to_smiles()}. &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;Not calculating this species.&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Unconverged&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># apply the troubleshooting methods in the `actions` list if they weren&#39;t already tried out</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to troubleshoot rotor </span><span class="si">{job.pivots}</span><span class="s1"> of </span><span class="si">{label}</span><span class="s1"> using </span><span class="si">{actions}</span><span class="s1">...&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_scan_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">actions</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">invalidate</span><span class="p">:</span>
                    <span class="c1"># the rotor scan is good, calculate the symmetry number</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">determine_rotor_symmetry</span><span class="p">(</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                        <span class="n">rotor_path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Rotor scan </span><span class="si">{scan}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> has symmetry </span><span class="si">{symmetry}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">scan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                        <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]))</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not match rotor with pivots </span><span class="si">{0}</span><span class="s1"> in species </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>

        <span class="c1"># Only continue if not troubleshooting the scan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">actions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">invalidate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># exclude reset conformer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invalidation_reason</span>
        <span class="c1"># If energies were obtained, draw the scan curve</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">):</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
            <span class="n">rotor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">plot_1d_rotor_scan</span><span class="p">(</span><span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">,</span>
                                       <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                       <span class="n">original_dihedral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">])</span>
        <span class="c1"># Save the Restart dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.check_directed_scan"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_directed_scan">[docs]</a>    <span class="k">def</span> <span class="nf">check_directed_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">energies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks (QA) whether the directed scan is relatively &quot;smooth&quot;,</span>
<span class="sd">        and whether the optimized geometry indeed represents the minimum energy conformer.</span>
<span class="sd">        Recommends whether or not to use this rotor using the &#39;successful_rotors&#39; and &#39;unsuccessful_rotors&#39; attributes.</span>
<span class="sd">        This method differs from check_directed_scan_job(), since here we consider the entire scan.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            pivots (list): The rotor pivots.</span>
<span class="sd">            scan (list): The four atoms defining the dihedral.</span>
<span class="sd">            energies (list): The rotor scan energies in kJ/mol.</span>

<span class="sd">        Todo:</span>
<span class="sd">            - Not used!!</span>
<span class="sd">            - adjust to ND, merge with check_directed_scan_job (this one isn&#39;t being called)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the job has not converged, troubleshoot</span>
        <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">scan_quality_check</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span>
                                                                               <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="c1"># the rotor scan is problematic, troubleshooting is required</span>
            <span class="k">if</span> <span class="s1">&#39;change conformer&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="c1"># a lower conformation was found</span>
                <span class="n">deg_increment</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">deg_increment</span><span class="o">=</span><span class="n">deg_increment</span><span class="p">)</span>
                <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                    <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">,</span>
                    <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="c1"># Remove all completed rotor calculation information</span>
                    <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">rotor_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># re-run opt (or composite) on the new initial_xyz with the desired dihedral</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The conformer is wrong, and changing the dihedral resulted in a non-isomorphic species.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;A lower conformer was found for </span><span class="si">{0}</span><span class="s1"> via a torsion mode, &#39;</span> \
                                                    <span class="s1">&#39;but it is not isomorphic with the 2D graph representation &#39;</span> \
                                                    <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">. Not calculating this species.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Unconverged&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Directed scan for species </span><span class="si">{0}</span><span class="s1"> for pivots </span><span class="si">{1}</span><span class="s1"> failed with: </span><span class="si">{2}</span><span class="s1">. &#39;</span>
                             <span class="s1">&#39;Currently rotor troubleshooting methods do not apply for directed scans. &#39;</span>
                             <span class="s1">&#39;Not troubleshooting rotor.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pivots</span><span class="p">:</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invalidation_reason</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># the rotor scan is good, calculate the symmetry number</span>
        <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pivots</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">invalidate</span><span class="p">:</span>
                    <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">determine_rotor_symmetry</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Rotor scan </span><span class="si">{scan}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> has symmetry </span><span class="si">{symmetry}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Save the Restart dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.check_directed_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_directed_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_directed_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a directed scan job for a specific dihedral angle converged successfully, otherwise troubleshoot.</span>

<span class="sd">        rotors_dict structure (attribute of ARCSpecies)::</span>

<span class="sd">            rotors_dict: {1: {&#39;pivots&#39;: ``list``,</span>
<span class="sd">                              &#39;top&#39;: ``list``,</span>
<span class="sd">                              &#39;scan&#39;: ``list``,</span>
<span class="sd">                              &#39;number_of_running_jobs&#39;: ``int``,</span>
<span class="sd">                              &#39;success&#39;: ``bool``,</span>
<span class="sd">                              &#39;invalidation_reason&#39;: ``str``,</span>
<span class="sd">                              &#39;times_dihedral_set&#39;: ``int``,</span>
<span class="sd">                              &#39;scan_path&#39;: &lt;path to scan output file&gt;,</span>
<span class="sd">                              &#39;max_e&#39;: ``float``,  # in kJ/mol,</span>
<span class="sd">                              &#39;symmetry&#39;: ``int``,</span>
<span class="sd">                              &#39;dimensions&#39;: ``int``,</span>
<span class="sd">                              &#39;original_dihedrals&#39;: ``list``,</span>
<span class="sd">                              &#39;cont_indices&#39;: ``list``,</span>
<span class="sd">                              &#39;directed_scan_type&#39;: ``str``,</span>
<span class="sd">                              &#39;directed_scan&#39;: ``dict``,  # keys: tuples of dihedrals as strings,</span>
<span class="sd">                                                          # values: dicts of energy, xyz, is_isomorphic, trsh</span>
<span class="sd">                             }</span>
<span class="sd">                          2: {}, ...</span>
<span class="sd">                         }</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The rotor scan job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_geometry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{dihedral:.2f}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">)</span>
                    <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span>
                        <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                        <span class="s1">&#39;is_isomorphic&#39;</span><span class="p">:</span> <span class="n">is_isomorphic</span><span class="p">,</span>
                        <span class="s1">&#39;trsh&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_md_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_md_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_md_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the MD spawning algorithm converged on a single structure.</span>
<span class="sd">        If not converged, spawn another MD job (up to a maximum number of jobs).</span>
<span class="sd">        If it did converge, save the resulting lowest conformers and DFT them.</span>

<span class="sd">        Args:</span>
<span class="sd">             label (str): The species label.</span>
<span class="sd">             job (Job): The Gromacs MD job to check.</span>
<span class="sd">             max_iterations (int, optional): The maximal number of MD trials per species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">conf_list</span> <span class="o">=</span> <span class="n">read_yaml_file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
        <span class="n">lowest_conf</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">conf_list</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span> <span class="o">=</span> <span class="n">lowest_conf</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not converge on a single conformer using Gromacs for species </span><span class="si">{0}</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;even after </span><span class="si">{1}</span><span class="s1"> iterations. Using the latest conformer.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">))</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># unconverged</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span> <span class="o">=</span> <span class="n">lowest_conf</span> \
                                                               <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">compare_confs</span><span class="p">(</span><span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="c1"># converged</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># same energy but different conformer? for now we&#39;ll consider it as converged</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;MD jobs for </span><span class="si">{0}</span><span class="s1"> converged with same energy conformer by different xyz:</span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;</span><span class="si">{1}</span><span class="se">\n\n</span><span class="s1">and</span><span class="se">\n\n</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Todo: reconsider</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># why did we found a higher conformer?</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not converge on a single conformer using Gromacs for species </span><span class="si">{label}</span><span class="s1">, got a higher&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;energy conformer. Using the latest lowest conformer.&#39;</span><span class="p">)</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># process conformers and DFT them</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Final conformer for </span><span class="si">{label}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{lowest_conf[0]}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="n">lowest_confs</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                       <span class="n">confs</span><span class="o">=</span><span class="n">conf_list</span><span class="p">,</span>
                                                       <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span><span class="p">,</span>
                                                       <span class="n">e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">standardize_xyz_string</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">lowest_confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowest_confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;gromacs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># spawn a new MD simulation</span>
            <span class="n">ordinal</span> <span class="o">=</span> <span class="n">get_ordinal_indicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1"> conformer for </span><span class="si">{2}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">ordinal</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="n">ordinal</span> <span class="o">=</span> <span class="n">get_ordinal_indicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Spawning the </span><span class="si">{0}{1}</span><span class="s1"> round of MD simulations for </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spawn_md_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prev_conf_list</span><span class="o">=</span><span class="n">conf_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_all_done"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_all_done">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that we have all required data for the species/TS.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_converged</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">spawn_job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">spawn_job_type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">])</span>
                             <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span>
                                 <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;fine&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">])</span>
                             <span class="ow">or</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;bde&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">bdes</span> <span class="ow">is</span> <span class="kc">None</span>
                             <span class="ow">or</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">and</span> <span class="s1">&#39;_BDE_&#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{label}</span><span class="s1"> did not converge&#39;</span><span class="p">)</span>
                <span class="n">all_converged</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">all_converged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">make_ts_report</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_report</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">zero_delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">conf_time</span> <span class="o">=</span> <span class="n">extermum_list</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                      <span class="n">return_min</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">opt_time</span> <span class="o">=</span> <span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> \
                <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">comp_time</span> <span class="o">=</span> <span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> \
                <span class="k">if</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">other_time</span> <span class="o">=</span> <span class="n">extermum_list</span><span class="p">([</span><span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                                        <span class="k">for</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">job_dictionary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]],</span> <span class="n">return_min</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span> \
                                                <span class="ow">or</span> <span class="p">(</span><span class="n">conf_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">opt_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> \
                                                <span class="o">+</span> <span class="p">(</span><span class="n">comp_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">other_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All jobs for species </span><span class="si">{label}</span><span class="s1"> successfully converged. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Run time: </span><span class="si">{self.species_dict[label].run_time}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_type_status</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{label}</span><span class="s1"> did not converge. Job type status is: </span><span class="si">{job_type_status}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.get_servers_jobs_ids"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.get_servers_jobs_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_servers_jobs_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check status on all active servers, return a list of relevant running job IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_running_jobs_ids</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">check_running_jobs_ids</span><span class="p">())</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_negative_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_negative_freq">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_negative_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshooting cases where non-TS species have negative frequencies.</span>
<span class="sd">        Run newly generated conformers.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The frequency job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_neg_freqs_trshed</span><span class="p">,</span> <span class="n">confs</span><span class="p">,</span> <span class="n">output_errors</span><span class="p">,</span> <span class="n">output_warnings</span> <span class="o">=</span> <span class="n">trsh_negative_freq</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span>
            <span class="n">neg_freqs_trshed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">,</span> <span class="n">job_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current_neg_freqs_trshed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">output_error</span> <span class="ow">in</span> <span class="n">output_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output_error</span>
        <span class="k">for</span> <span class="n">output_warning</span> <span class="ow">in</span> <span class="n">output_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output_warning</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting all currently running jobs for species </span><span class="si">{0}</span><span class="s1"> before troubleshooting for&#39;</span>
                        <span class="s1">&#39; negative frequency...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span> <span class="o">=</span> <span class="n">confs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># initialize the conformer job dictionary</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshooting rotor scans</span>
<span class="sd">        Using the following methods: freezing all dihedrals other than the scan&#39;s pivots for this job,</span>
<span class="sd">        or increasing the scan resolution.</span>

<span class="sd">        Args:</span>
<span class="sd">            job (Job): The scan Job object.</span>
<span class="sd">            methods (list): The troubleshooting method/s to try. Optional values: &#39;freeze&#39;, &#39;inc_res&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">species_name</span>
        <span class="n">scan_trsh_str</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">scan_trsh_str</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will not troubleshoot a rotor scan for </span><span class="si">{label}</span><span class="s1"> more than once with the exact &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;same methods (</span><span class="si">{scan_trsh_str}</span><span class="s1">).&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">species_scan_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span> <span class="o">=</span> <span class="n">trsh_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span>
                                                <span class="n">species_scan_lists</span><span class="o">=</span><span class="n">species_scan_lists</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_level_of_theory_dict</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                         <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">scan_res</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_opt_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_opt_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_opt_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We&#39;re troubleshooting for opt jobs.</span>
<span class="sd">        First check for server status and troubleshoot if needed. Then check for ESS status and troubleshoot</span>
<span class="sd">        if needed. Finally, check whether or not the last job had fine=True, add if it didn&#39;t run with fine.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous_job_num</span><span class="p">,</span> <span class="n">latest_job_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># get latest Job object for the species / TS</span>
            <span class="n">job_name_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">job_name_int</span> <span class="o">&gt;</span> <span class="n">latest_job_num</span><span class="p">:</span>
                <span class="n">previous_job_num</span> <span class="o">=</span> <span class="n">latest_job_num</span>
                <span class="n">latest_job_num</span> <span class="o">=</span> <span class="n">job_name_int</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="c1"># run_opt_job should not be called if all looks good...</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;opt job for </span><span class="si">{label}</span><span class="s1"> seems right, yet &quot;run_opt_job&quot; was called.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;opt job for </span><span class="si">{label}</span><span class="s1"> seems right, yet &quot;run_opt_job&quot; was called.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Run opt again using a finer grid.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">xyz</span>  <span class="c1"># save for troubleshooting, since trsh goes by initial</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trsh_opt</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># job passed on the server, but failed in ESS calculation</span>
                <span class="k">if</span> <span class="n">previous_job_num</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">previous_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;opt_a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">previous_job_num</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">fine</span> <span class="ow">and</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span> \
                            <span class="ow">and</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                        <span class="c1"># The present job with a fine grid failed in the ESS calculation.</span>
                        <span class="c1"># A *previous* job without a fine grid terminated successfully on the server and ESS.</span>
                        <span class="c1"># So use the xyz determined w/o the fine grid, and output an error message to alert users.</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimization job for </span><span class="si">{label}</span><span class="s1"> with a fine grid terminated successfully &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;on the server, but crashed during calculation. NOT running with fine &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;grid again.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">previous_job</span><span class="p">)</span>
                        <span class="n">trsh_opt</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">trsh_opt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_ess"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_ess">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_ess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot issues related to the electronic structure software, such as conversion.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (Job): The job object to troubleshoot.</span>
<span class="sd">            level_of_theory (str or dict): The level of theory to use.</span>
<span class="sd">            conformer (str, optional): The conformer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{label}</span><span class="s1"> job </span><span class="si">{job.job_name}</span><span class="s1"> which failed with status: &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{job.job_status[1][&quot;status&quot;]}</span><span class="s1">,&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;with keywords: </span><span class="si">{job.job_status[1][&quot;keywords&quot;]}</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;in </span><span class="si">{job.software}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;The error &quot;</span><span class="si">{job.job_status[1][&quot;error&quot;]}</span><span class="s1">&quot; was derived from the following line in the log &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;file:</span><span class="se">\n</span><span class="s1">&quot;</span><span class="si">{job.job_status[1][&quot;line&quot;]}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conformer</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">conformer</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>

        <span class="k">if</span> <span class="s1">&#39;Unknown&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;change_node&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;change_node&#39;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_server</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">checkfile</span>
        <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">format_level_of_theory_inputs</span><span class="p">(</span><span class="n">level_of_theory</span><span class="p">)</span>
        <span class="c1"># determine if the species is a hydrogen (or its isotope) atom</span>
        <span class="n">is_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">output_errors</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">remove_checkfile</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> \
            <span class="n">memory</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="p">,</span> <span class="n">dont_rerun</span> <span class="o">=</span> \
            <span class="n">trsh_ess_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">level_of_theory_dict</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">,</span>
                         <span class="n">job_status</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">is_h</span><span class="o">=</span><span class="n">is_h</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                         <span class="n">num_heavy_atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_heavy_atoms</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                         <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">memory_gb</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">total_job_memory_gb</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">,</span>
                         <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">available_ess</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">output_error</span> <span class="ow">in</span> <span class="n">output_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output_error</span>
        <span class="k">if</span> <span class="n">remove_checkfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dont_rerun</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">software</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh_keyword</span><span class="p">,</span>
                         <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span>
                         <span class="n">directed_dihedrals</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_dihedrals</span><span class="p">,</span> <span class="n">directed_scans</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_scans</span><span class="p">,</span>
                         <span class="n">cpu_cores</span><span class="o">=</span><span class="n">cpu_cores</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_conformer_isomorphism"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_conformer_isomorphism">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_conformer_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot conformer optimization for a species that failed isomorphic test in</span>
<span class="sd">        `determine_most_stable_conformer`.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The troubleshoot_conformer_isomorphism() method does not yet deal with TSs.&#39;</span><span class="p">)</span>

        <span class="n">num_of_conformers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_of_conformers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The troubleshoot_conformer_isomorphism() method got zero conformers.&#39;</span><span class="p">)</span>

        <span class="c1"># use the first conformer of a species to determine applicable troubleshooting method</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">level_of_theory</span> <span class="o">=</span> <span class="n">trsh_conformer_isomorphism</span><span class="p">(</span><span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">level_of_theory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ARC has attempted all built-in conformer isomorphism troubleshoot methods for species &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{label}</span><span class="s1">. No conformer for this species was found to be isomorphic with the 2D graph &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;representation {self.species_dict[label].mol.copy(deep=True).to_smiles()}. &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;NOT optimizing this species.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Error: No conformer was found to be isomorphic with the 2D&#39;</span> \
                                                <span class="s1">&#39; graph representation!; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting conformer job in </span><span class="si">{job.software}</span><span class="s1"> using </span><span class="si">{level_of_theory}</span><span class="s1"> for species </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># rerun conformer job at higher level for all conformers</span>
            <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_conformers</span><span class="p">):</span>

                <span class="c1"># initial xyz before troubleshooting</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers_before_opt</span><span class="p">[</span><span class="n">conformer</span><span class="p">]</span>

                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;Conformers: &#39;</span> <span class="o">+</span> <span class="n">level_of_theory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Conformers: &#39;</span> <span class="o">+</span> <span class="n">level_of_theory</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.delete_all_species_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.delete_all_species_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all_species_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all jobs of a species/TS.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting all jobs for species </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleted job </span><span class="si">{job_name}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.restore_running_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.restore_running_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">restore_running_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make Job objects for jobs which were running in the previous session.</span>
<span class="sd">        Important for the restart feature so long jobs won&#39;t be ran twice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jobs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;It seems that there are no running jobs specified in the ARC restart file. &#39;</span>
                         <span class="s1">&#39;Assuming all jobs have finished.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARC&#39;s restart files indicate the following jobs are still running: {list(jobs.values())}&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">job_description</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conformer</span><span class="si">{job_description[&quot;conformer&quot;]}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">spc_label</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find species </span><span class="si">{spc_label}</span><span class="s1"> in the restart file&#39;</span><span class="p">)</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">job_dict</span><span class="o">=</span><span class="n">job_description</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">job</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">job</span>
                        <span class="c1"># don&#39;t generate additional conformers for this species</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc_label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;Restarting ARC, tracking the following jobs spawned in a previous session:&#39;</span>
                <span class="k">for</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">spc_label</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>
                    <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="s1">&#39;conformers&#39;</span><span class="p">:</span>
                                <span class="n">content</span> <span class="o">+=</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_name</span> \
                                           <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (conformer</span><span class="si">{job_name}</span><span class="s1">), &#39;</span>
                <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.save_restart_dict"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.save_restart_dict">[docs]</a>    <span class="k">def</span> <span class="nf">save_restart_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the restart_dict and save the restart.yml file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating a restart file...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">][</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">job_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;mer&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dumping restart dictionary:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">))</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.make_reaction_labels_info_file"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.make_reaction_labels_info_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_reaction_labels_info_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A helper function for creating the `reactions labels.info` file&quot;&quot;&quot;</span>
        <span class="n">rxn_info_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction labels.info&#39;</span><span class="p">)</span>
        <span class="n">old_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction labels.old.info&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="n">old_file_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Reaction labels and respective TS labels:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rxn_info_path</span></div>

<div class="viewcode-block" id="Scheduler.determine_adaptive_level"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_adaptive_level">[docs]</a>    <span class="k">def</span> <span class="nf">determine_adaptive_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">heavy_atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the level of theory to be used according to the job type and number of heavy atoms.</span>
<span class="sd">        self.adaptive_levels is a dictionary of levels of theory for ranges of the number of heavy atoms in the</span>
<span class="sd">        molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are dictionaries with &#39;optfreq&#39; and &#39;sp&#39;</span>
<span class="sd">        as keys and levels of theory as values. &#39;inf&#39; is accepted an max_num_atoms.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_level_of_theory (str): The level of theory for non-sp/opt/freq job types.</span>
<span class="sd">            job_type (str): The job type for which the level of theory is determined.</span>
<span class="sd">            heavy_atoms (int): The number of heavy atoms in the species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">level_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">and</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not determine adaptive level of theory for </span><span class="si">{0}</span><span class="s1"> heavy atoms using &#39;</span>
                                     <span class="s1">&#39;the following adaptive levels:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;optfreq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Could not find the &#39;optfreq&#39; key in the adaptive levels dictionary for &quot;</span>
                                         <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> heavy atoms. Got:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">level_dict</span><span class="p">[</span><span class="s1">&#39;optfreq&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;sp&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Could not find the &#39;sp&#39; key in the adaptive levels dictionary for &quot;</span>
                                         <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> heavy atoms. Got:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">level_dict</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for any other job type use the original level of theory regardless of the number of atoms</span>
                <span class="k">return</span> <span class="n">original_level_of_theory</span></div>

<div class="viewcode-block" id="Scheduler.initialize_output_dict"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.initialize_output_dict">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_output_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize self.output.</span>
<span class="sd">        Do not initialize keys that will contain paths (&#39;geo&#39;, &#39;freq&#39;, &#39;sp&#39;, &#39;composite&#39;),</span>
<span class="sd">        their existence indicate the job was terminated for restarting purposes.</span>
<span class="sd">        If `label` is not None, will initialize for a specific species, otherwise will initialize for all species.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str, optional): A species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_output_dict_contain_info</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;paths&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">path_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path_keys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;irc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;job_types&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">,</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">,</span> <span class="s1">&#39;irc&#39;</span><span class="p">]:</span>
                            <span class="c1"># rotors could be invalidated due to many reasons,</span>
                            <span class="c1"># also could be falsely identified in a species that has no torsional modes.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;isomorphism&#39;</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="s1">&#39;warnings&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

    <span class="k">def</span> <span class="nf">_does_output_dict_contain_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether self.output contains any information other than the initialized structure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether self.output contains any information, `True` if it does.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">species_output_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key0</span><span class="p">,</span> <span class="n">val0</span> <span class="ow">in</span> <span class="n">species_output_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key0</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">,</span> <span class="s1">&#39;job_types&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="n">key0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">val1</span> <span class="ow">and</span> <span class="n">key1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">]:</span>
                            <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="sum_time_delta"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.sum_time_delta">[docs]</a><span class="k">def</span> <span class="nf">sum_time_delta</span><span class="p">(</span><span class="n">timedelta_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for summing datetime.timedelta objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        timedelta_list (list): Time delta&#39;s to sum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">timedelta</span> <span class="ow">in</span> <span class="n">timedelta_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">timedelta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">timedelta</span>
    <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>